"""
API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–ú–£–õ–¨–¢–ò-–¢–ï–ù–ê–ù–¢–ù–ê–Ø –í–ï–†–°–ò–Ø).

–û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –º—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å:
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ company_id –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ tenant —Å—Ö–µ–º—ã
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ get_tenant_session() –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å tenant —Å–µ—Å—Å–∏—è–º–∏
- –ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –∫–æ–º–ø–∞–Ω–∏—è–º–∏
"""
from datetime import datetime, date
from typing import Optional, Annotated, List
from fastapi import APIRouter, Depends, Query, HTTPException, Body
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, and_, or_, func, text
from sqlalchemy.orm import selectinload

from app.database import get_db
from app.api.auth import get_current_user
from app.schemas.user import UserResponse, UserCreateRequest, UserUpdateRequest
from shared.database.models import User, Client, Booking
from app.services.tenant_service import get_tenant_service

router = APIRouter(prefix="/api/users", tags=["users"])


@router.get("", response_model=List[UserResponse])
async def get_users(
    page: int = Query(1, ge=1),
    page_size: int = Query(20, ge=1, le=100),
    search: Optional[str] = None,
    company_id: Optional[int] = Query(None, description="ID –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è tenant —Å–µ—Å—Å–∏–∏"),
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    if not current_user.is_admin:
        raise HTTPException(status_code=403, detail="–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    
    # –ü–æ–ª—É—á–∞–µ–º tenant —Å–µ—Å—Å–∏—é –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞)
    tenant_session = None
    if company_id:
        tenant_service = get_tenant_service()
        async for session in tenant_service.get_tenant_session(company_id):
            tenant_session = session
            break
    else:
        # –î–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ API –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é —Å–µ—Å—Å–∏—é
        tenant_session = db
    
    query = select(User).options(
        selectinload(User.client),
    )
    
    # –§–∏–ª—å—Ç—Ä—ã
    conditions = []
    if search:
        search_term = f"%{search}%"
        query = query.join(User).where(
            or_(
                User.username.ilike(search_term),
                User.first_name.ilike(search_term),
                User.last_name.ilike(search_term),
                User.phone.ilike(search_term),
                User.telegram_id.ilike(search_term),
            )
        )
    
    # –ü–æ–¥—Å—á–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
    count_query = select(func.count(User.id))
    if search:
        count_query = count_query.join(User).where(
            or_(
                User.username.ilike(search_term),
                User.first_name.ilike(search_term),
                User.last_name.ilike(search_term),
                User.phone.ilike(search_term),
                User.telegram_id.ilike(search_term),
            )
        )
    
    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
    total = await tenant_session.scalar(count_query) or 0
    
    # –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
    query = query.offset((page - 1) * page_size).limit(page_size)
    query = query.order_by(User.created_at.desc())
    
    result = await tenant_session.execute(query)
    users = result.scalars().all()
    
    print(f"üìä –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: total={total}, page={page}, page_size={page_size}, company_id={company_id}")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç—ã —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    items = []
    for user in users:
        # –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –∏—Å—Ç–µ–∫—à–µ–π –ø–æ–¥–ø–∏—Å–∫–µ (–¥–ª—è –∫–æ–º–ø–∞–Ω–∏–π —Å –ø–æ–¥–ø–∏—Å–∫–æ–π)
        is_blocked = False
        if company_id and not current_user.is_master:
            # TODO: –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏
            # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞ - –±–ª–æ–∫–∏—Ä—É–µ–º –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
            pass
        
        user_dict = {
            "id": user.id,
            "telegram_id": user.telegram_id,
            "username": user.username,
            "first_name": user.first_name,
            "last_name": user.last_name,
            "phone": user.phone,
            "is_admin": user.is_admin,
            "is_master": user.is_master,
            "is_blocked": is_blocked,
            "is_client": user.is_client,
            "created_at": user.created_at,
            "updated_at": user.updated_at,
            "client": None,  # –í—Ä–µ–º–µ–Ω–Ω–æ, –±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
            "blocked_at": None,
        }
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
        if user.is_client:
            async for client_session in tenant_session.execute(
                select(Client).where(Client.id == user.id)
            ):
                client = await client_session.scalar_one_or_none()
                if client:
                    user_dict["client"] = {
                        "id": client.id,
                        "full_name": client.full_name,
                        "phone": client.phone,
                        "car_brand": client.car_brand,
                        "car_model": client.car_model,
                    }
        
        items.append(UserResponse.model_validate(user_dict))
    
    return {
        "items": items,
        "total": total,
        "page": page,
        "page_size": page_size,
        "company_id": company_id,
    }


@router.get("/{user_id}", response_model=UserResponse)
async def get_user(
    user_id: int,
    company_id: Optional[int] = Query(None, description="ID –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è tenant —Å–µ—Å—Å–∏–∏"),
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
    if not current_user.is_admin:
        raise HTTPException(status_code=403, detail="–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    
    # –ü–æ–ª—É—á–∞–µ–º tenant —Å–µ—Å—Å–∏—é –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞)
    tenant_session = None
    if company_id:
        tenant_service = get_tenant_service()
        async for session in tenant_service.get_tenant_session(company_id):
            tenant_session = session
            break
    else:
        # –î–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ API –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é —Å–µ—Å—Å–∏—é
        tenant_session = db
    
    query = select(User).options(
        selectinload(User.client),
    ).where(User.id == user_id)
    
    result = await tenant_session.execute(query)
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    print(f"üîç –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: user_id={user_id}, company_id={company_id}")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    user_dict = {
        "id": user.id,
        "telegram_id": user.telegram_id,
        "username": user.username,
        "first_name": user.first_name,
        "last_name": user.last_name,
        "phone": user.phone,
        "is_admin": user.is_admin,
        "is_master": user.is_master,
        "is_client": user.is_client,
        "is_blocked": user.is_blocked,
        "created_at": user.created_at,
        "updated_at": user.updated_at,
        "client": None,  # –í—Ä–µ–º–µ–Ω–Ω–æ, –±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
    }
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–ª–∏–µ–Ω—Ç–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    if user.is_client:
        async for session in tenant_session.execute(
                select(Client).where(Client.id == user.id)
            ):
                client = await session.scalar_one_or_none()
                if client:
                    user_dict["client"] = {
                        "id": client.id,
                        "full_name": client.full_name,
                        "phone": client.phone,
                        "car_brand": client.car_brand,
                        "car_model": client.car_model,
                    }
    
    return UserResponse.model_validate(user_dict)


@router.post("", response_model=UserResponse, status_code=201)
async def create_user(
    user_data: UserCreateRequest,
    company_id: Optional[int] = Query(None, description="ID –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è tenant —Å–µ—Å—Å–∏–∏"),
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if not current_user.is_admin:
        raise HTTPException(status_code=403, detail="–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    
    # –ü–æ–ª—É—á–∞–µ–º tenant —Å–µ—Å—Å–∏—é –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞)
    tenant_session = None
    if company_id:
        tenant_service = get_tenant_service()
        async for session in tenant_service.get_tenant_session(company_id):
            tenant_session = session
            break
    else:
        # –î–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ API –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é —Å–µ—Å—Å–∏—é
        tenant_session = db
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º telegram_id
    existing_user = await tenant_session.execute(
        select(User).where(User.telegram_id == user_data.telegram_id)
    ).scalar_one_or_none()
    
    if existing_user:
        raise HTTPException(status_code=400, detail=f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å telegram_id {user_data.telegram_id} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º username
    existing_username = await tenant_session.execute(
        select(User).where(User.username == user_data.username)
    ).scalar_one_or_none()
    
    if existing_username:
        raise HTTPException(status_code=400, detail=f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å username {user_data.username} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = User(
        telegram_id=user_data.telegram_id,
        username=user_data.username,
        first_name=user_data.first_name,
        last_name=user_data.last_name,
        phone=user_data.phone,
        is_admin=False,
        is_master=False,
        is_client=True,
        is_blocked=False,
        created_at=datetime.utcnow(),
        updated_at=datetime.utcnow(),
    )
    
    tenant_session.add(user)
    await tenant_session.commit()
    await tenant_session.refresh(user)
    
    print(f"‚úÖ –°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: telegram_id={user_data.telegram_id}, username={user_data.username}")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    user_dict = {
        "id": user.id,
        "telegram_id": user.telegram_id,
        "username": user.username,
        "first_name": user.first_name,
        "last_name": user.last_name,
        "phone": user.phone,
        "is_admin": user.is_admin,
        "is_master": user.is_master,
        "is_client": user.is_client,
        "is_blocked": user.is_blocked,
        "is_client": True,
        "created_at": user.created_at,
        "updated_at": user.updated_at,
    }
    
    return UserResponse.model_validate(user_dict)


@router.patch("/{user_id}", response_model=UserResponse)
async def update_user(
    user_id: int,
    user_data: UserUpdateRequest,
    company_id: Optional[int] = Query(None, description="ID –∫–æ–º–ø–∞–Ω–∏–∏ –¥–ª—è tenant —Å–µ—Å—Å–∏–∏"),
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    """–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ"""
    if not current_user.is_admin:
        raise HTTPException(status_code=403, detail="–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
    
    # –ü–æ–ª—É—á–∞–µ–º tenant —Å–µ—Å—Å–∏—é –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞)
    tenant_session = None
    if company_id:
        tenant_service = get_tenant_service()
        async for session in tenant_service.get_tenant_session(company_id):
            tenant_session = session
            break
    else:
        # –î–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ API –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é —Å–µ—Å—Å–∏—é
        tenant_session = db
    
    query = select(User).where(User.id == user_id)
    result = await tenant_session.execute(query)
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã–µ —É–∫–∞–∑–∞–Ω—ã –≤ –∑–∞–ø—Ä–æ—Å–µ
    update_data = {}
    if user_data.first_name is not None:
        update_data["first_name"] = user_data.first_name
    if user_data.last_name is not None:
        update_data["last_name"] = user_data.last_name
    if user_data.phone is not None:
        update_data["phone"] = user_data.phone
    if user_data.is_admin is not None:
        update_data["is_admin"] = user_data.is_admin
    if user_data.is_master is not None:
        update_data["is_master"] = user_data.is_master
    if user_data.is_client is not None:
        update_data["is_client"] = user_data.is_client
    
    # –û–±–Ω–æ–≤–ª—è–µ–º timestamp
    update_data["updated_at"] = datetime.utcnow()
    
    # –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    result = await tenant_session.execute(
        select(User).where(User.id == user_id)
    )
    user = result.scalar_one_or_none()
    
    if not user:
        raise HTTPException(status_code=404, detail="–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    for key, value in update_data.items():
        setattr(user, key, value)
    
    user.updated_at = update_data["updated_at"]
    
    await tenant_session.commit()
    await tenant_session.refresh(user)
    
    print(f"‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: user_id={user_id}, company_id={company_id}")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    user_dict = {
        "id": user.id,
        "telegram_id": user.telegram_id,
        "username": user.username,
        "first_name": user.first_name,
        "last_name": user.last_name,
        "phone": user.phone,
        "is_admin": user.is_admin,
        "is_master": user.is_master,
        "is_client": user.is_client,
        "is_blocked": user.is_blocked,
        "created_at": user.created_at,
        "updated_at": user.updated_at,
        "client": None,
    }
    
    return UserResponse.model_validate(user_dict)


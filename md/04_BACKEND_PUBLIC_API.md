# –≠—Ç–∞–ø 4: Backend - –ü—É–±–ª–∏—á–Ω—ã–µ API

**–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 2 –¥–Ω—è  
**–°—Ç–∞—Ç—É—Å:** ‚è≥ –í –æ–∂–∏–¥–∞–Ω–∏–∏  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–¶–µ–ª—å —ç—Ç–∞–ø–∞](#—Ü–µ–ª—å-—ç—Ç–∞–ø–∞)
2. [–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è](#–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
3. [–ü–æ–¥–∑–∞–¥–∞—á–∏](#–ø–æ–¥–∑–∞–¥–∞—á–∏)
4. [–ß–µ–∫-–ª–∏—Å—Ç —ç—Ç–∞–ø–∞](#—á–µ–∫-–ª–∏—Å—Ç-—ç—Ç–∞–ø–∞)
5. [–†–∏—Å–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ](#—Ä–∏—Å–∫–∏-–∏-–∏—Ö-—Ä–µ—à–µ–Ω–∏–µ)

---

## üéØ –¶–µ–ª—å —ç—Ç–∞–ø–∞

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ API –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

- –ü—É–±–ª–∏—á–Ω—ã–µ API endpoints —Ä–∞–±–æ—Ç–∞—é—Ç
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –Æ–∫–∞—Å—Å–æ–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- Webhook –æ—Ç –Æ–∫–∞—Å—Å—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã

---

## üîß –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã

- [ ] –≠—Ç–∞–ø 2 –∑–∞–≤–µ—Ä—à–µ–Ω (–º–æ–¥–µ–ª–∏ –∏ —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã)
- [ ] –≠—Ç–∞–ø 3 –∑–∞–≤–µ—Ä—à–µ–Ω (–º—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç)
- [ ] –ï—Å—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω –Æ–∫–∞—Å—Å—ã
- [ ] –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å webhook

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.11+ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- aiohttp —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- –¢–µ—Å—Ç–æ–≤—ã–π –º–∞–≥–∞–∑–∏–Ω –Æ–∫–∞—Å—Å—ã –¥–æ—Å—Ç—É–ø–µ–Ω
- –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å API Telegram –∏ –Æ–∫–∞—Å—Å—ã

---

## üìù –ü–æ–¥–∑–∞–¥–∞—á–∏

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 4.1: –°–æ–∑–¥–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π API –º–æ–¥—É–ª—å

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö API.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/api/public.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–æ—É—Ç–µ—Ä:
   ```python
   from fastapi import APIRouter, HTTPException
   from pydantic import BaseModel, Field

   router = APIRouter(prefix="/api/public", tags=["public"])
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –ú–æ–¥—É–ª—å —Å–æ–∑–¥–∞–Ω
- [ ] –†–æ—É—Ç–µ—Ä –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
- [ ] –ü—Ä–µ—Ñ–∏–∫—Å /api/public
- [ ] –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 4.2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Telegram API.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å Pydantic —Å—Ö–µ–º—É:
   ```python
   class ValidateBotTokenRequest(BaseModel):
       token: str = Field(..., min_length=50, max_length=500, description="–¢–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç @BotFather")
   
   class ValidateBotTokenResponse(BaseModel):
       valid: bool
       bot_info: Optional[dict]
       error: Optional[str]
   ```

2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint:
   ```python
   import aiohttp
   import logging
   
   logger = logging.getLogger(__name__)
   
   @router.post("/validate-bot-token", response_model=ValidateBotTokenResponse)
   async def validate_bot_token(request: ValidateBotTokenRequest):
       """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Telegram API"""
       try:
           # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ Telegram API
           async with aiohttp.ClientSession() as session:
               url = f"https://api.telegram.org/bot{request.token}/getMe"
               async with session.get(url) as response:
                   data = await response.json()
                   
                   if not data.get("ok"):
                       return ValidateBotTokenResponse(
                           valid=False,
                           error=data.get("description", "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞")
                       )
                   
                   bot_info = data["result"]
                   
                   # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –±–æ—Ç
                   if not bot_info.get("is_bot"):
                       return ValidateBotTokenResponse(
                           valid=False,
                           error="–≠—Ç–æ—Ç —Ç–æ–∫–µ–Ω –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –±–æ—Ç—É"
                       )
                   
                   return ValidateBotTokenResponse(
                       valid=True,
                       bot_info=bot_info
                   )
       
       except aiohttp.ClientError as e:
           logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Ç–æ–∫–µ–Ω–∞: {e}")
           return ValidateBotTokenResponse(
               valid=False,
               error="–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Telegram API"
           )
       except Exception as e:
           logger.error(f"–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {e}", exc_info=True)
           return ValidateBotTokenResponse(
               valid=False,
               error="–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"
           )
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] Endpoint —Å–æ–∑–¥–∞–Ω
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram API —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ is_bot —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 4.3: –°–æ–∑–¥–∞—Ç—å YooKassa —Å–µ—Ä–≤–∏—Å

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –Æ–∫–∞—Å—Å–æ–π.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/services/yookassa_service.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–µ—Ä–≤–∏—Å:
   ```python
   from typing import Optional, Dict, Any
   from decimal import Decimal
   import aiohttp
   import hmac
   import hashlib
   import base64
   import logging
   
   from app.config import settings
   
   logger = logging.getLogger(__name__)
   
   class YooKassaService:
       """–°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Æ–∫–∞—Å—Å–æ–π"""
       
       def __init__(self):
           # –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ env
           self.shop_id = getattr(settings, 'YOOKASSA_SHOP_ID', '')
           self.secret_key = getattr(settings, 'YOOKASSA_SECRET_KEY', '')
           self.api_url = getattr(settings, 'YOOKASSA_API_URL', 'https://api.yookassa.ru/v3/payments')
       
       async def create_payment(
           self,
           amount: Decimal,
           description: str,
           metadata: Dict[str, Any]
       ) -> Dict[str, Any]:
           """–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞"""
           try:
               payload = {
                   "amount": {
                       "value": str(amount),
                       "currency": "RUB"
                   },
                   "description": description,
                   "metadata": metadata,
                   "capture": True,  # –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–∞–∑—É
                   "confirmation": {
                       "type": "redirect",
                       "return_url": f"{getattr(settings, 'FRONTEND_URL', '')}/payment-success"
                   }
               }
               
               # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Basic Auth
               auth = aiohttp.BasicAuth(
                   self.shop_id,
                   self.secret_key
               )
               
               async with aiohttp.ClientSession() as session:
                   async with session.post(
                       self.api_url,
                       json=payload,
                       auth=auth
                   ) as response:
                       data = await response.json()
                       
                       if response.status != 200:
                           logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: {data}")
                           raise Exception(f"–û—à–∏–±–∫–∞ –Æ–∫–∞—Å—Å—ã: {data.get('message', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')}")
                       
                       return data
       
       async def get_payment(self, payment_id: str) -> Optional[Dict[str, Any]]:
           """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–ª–∞—Ç–µ–∂–µ"""
           try:
               auth = aiohttp.BasicAuth(
                   self.shop_id,
                   self.secret_key
               )
               
               url = f"{self.api_url}/{payment_id}"
               
               async with aiohttp.ClientSession() as session:
                   async with session.get(url, auth=auth) as response:
                       data = await response.json()
                       
                       return data
       
           except Exception as e:
               logger.error(f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: {e}")
               return None
       
       def verify_webhook_signature(self, payload: str, signature: str) -> bool:
           """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook"""
           # HMAC SHA256 –ø—Ä–æ–≤–µ—Ä–∫–∞
           hmac_obj = hmac.new(
               self.secret_key.encode('utf-8'),
               payload.encode('utf-8'),
               hashlib.sha256
           )
           digest = hmac_obj.digest()
           calculated_signature = base64.b64encode(digest).decode('utf-8')
           
           return calculated_signature == signature
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] YooKassaService —Å–æ–∑–¥–∞–Ω
- [ ] create_payment —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] get_payment —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] verify_webhook_signature —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 4.4: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å Pydantic —Å—Ö–µ–º—ã:
   ```python
   class CreatePaymentRequest(BaseModel):
       plan_id: int = Field(..., ge=1, description="ID —Ç–∞—Ä–∏—Ñ–Ω–æ–≥–æ –ø–ª–∞–Ω–∞")
       company_data: CompanyCreate
       
       class Config:
           from_attributes = True
   
   class CreatePaymentResponse(BaseModel):
       payment_url: str
       payment_id: str
       amount: Decimal
       currency: str
       status: str
   ```

2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint:
   ```python
   from sqlalchemy.ext.asyncio import AsyncSession
   from sqlalchemy import select
   from decimal import Decimal
   
   from app.database import get_session_with_schema
   from app.models.company import Company
   from app.models.plan import Plan
   from app.models.payment import Payment
   from app.schemas.company import CompanyCreate, CompanyResponse
   from app.services.company_service import create_company
   from app.services.payment_service import create_payment
   from app.services.yookassa_service import YooKassaService
   from app.services.tenant_service import TenantService
   
   @router.post("/create-payment", response_model=CreatePaymentResponse)
   async def create_payment_registration(
       request: CreatePaymentRequest,
       db: AsyncSession = Depends(get_db)
   ):
       """–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏"""
       try:
           # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–∞–Ω
           plan_result = await db.execute(
               select(Plan).where(Plan.id == request.plan_id)
           )
           plan = plan_result.scalar_one_or_none()
           
           if not plan:
               raise HTTPException(
                   status_code=404,
                   detail=f"–¢–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω —Å ID {request.plan_id} –Ω–µ –Ω–∞–π–¥–µ–Ω"
               )
           
           # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–æ–º–ø–∞–Ω–∏—è —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º
           existing_company = await db.execute(
               select(Company).where(Company.code == request.company_data.code)
           ).scalar_one_or_none()
           
           if existing_company:
               raise HTTPException(
                   status_code=400,
                   detail="–ö–æ–º–ø–∞–Ω–∏—è —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
               )
           
           # 3. –°–æ–∑–¥–∞–µ–º –∫–æ–º–ø–∞–Ω–∏—é —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º pending
           company_data = request.company_data.model_dump()
           company_data['is_active'] = False  # –ù–µ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ –æ–ø–ª–∞—Ç—ã
           company_data['subscription_status'] = 'pending'
           company_data['subscription_end_date'] = None
           company_data['can_create_bookings'] = False
           
           company = await create_company(db, company_data)
           
           # 4. –°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç–µ–∂ —á–µ—Ä–µ–∑ –Æ–∫–∞—Å—Å—É
           yookassa = YooKassaService()
           
           payment_result = await yookassa.create_payment(
               amount=Decimal(str(plan.price_monthly)),
               description=f"–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–∞—Ä–∏—Ñ {plan.name}",
               metadata={
                   "company_id": company.id,
                   "plan_id": plan.id,
                   "company_name": company.name
               }
           )
           
           # 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–ª–∞—Ç–µ–∂–µ
           payment_data = {
               "company_id": company.id,
               "amount": Decimal(str(payment_result['amount']['value'])),
               "currency": payment_result['amount']['currency'],
               "payment_method": "yookassa",
               "yookassa_payment_id": payment_result['id'],
               "yookassa_payment_status": payment_result['status'],
               "status": "pending",
               "metadata": {
                   "plan_id": plan.id,
                   "company_name": company.name
               }
           }
           
           payment = await create_payment(db, payment_data)
           
           return CreatePaymentResponse(
               payment_url=payment_result['confirmation']['confirmation_url'],
               payment_id=payment_result['id'],
               amount=Decimal(str(payment_result['amount']['value'])),
               currency=payment_result['amount']['currency'],
               status=payment_result['status']
           )
       
       except HTTPException:
           raise
       except Exception as e:
           logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: {e}", exc_info=True)
           raise HTTPException(
               status_code=500,
               detail="–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞"
           )
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] Endpoint —Å–æ–∑–¥–∞–Ω
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ –Æ–∫–∞—Å—Å—É —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 4.5: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∫–æ–º–ø–∞–Ω–∏–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π endpoint —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏ —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–ª–∞—Ç–µ–∂–∞.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
   ```python
   @router.post("/companies/register", response_model=CreatePaymentResponse)
   async def register_company(
       request: CreatePaymentRequest,
       db: AsyncSession = Depends(get_db)
   ):
       """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–ª–∞—Ç–µ–∂–∞"""
       # –õ–æ–≥–∏–∫–∞ –∏–∑ –ø–æ–¥–∑–∞–¥–∞—á–∏ 4.4
       # ...
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] Endpoint —Å–æ–∑–¥–∞–Ω
- [ ] –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–µ—Ç—Å—è
- [ ] –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è URL –æ–ø–ª–∞—Ç—ã

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 4.6: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å webhook –æ—Ç –Æ–∫–∞—Å—Å—ã

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook –æ—Ç –Æ–∫–∞—Å—Å—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å Pydantic —Å—Ö–µ–º—ã:
   ```python
   class YooKassaWebhook(BaseModel):
       event: str = Field(..., description="–¢–∏–ø —Å–æ–±—ã—Ç–∏—è")
       object: Dict[str, Any] = Field(..., description="–û–±—ä–µ–∫—Ç –ø–ª–∞—Ç–µ–∂–∞")
   ```

2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint:
   ```python
   from fastapi import BackgroundTasks
   import asyncio
   from datetime import date, timedelta
   
   from app.database import get_session_with_schema
   from app.models.company import Company
   from app.models.subscription import Subscription
   from app.models.payment import Payment
   from app.services.payment_service import update_payment
   from app.services.subscription_service import create_subscription
   from app.services.tenant_service import TenantService
   from app.services.yookassa_service import YooKassaService
   
   @router.post("/payments/yookassa/webhook")
   async def yookassa_webhook(
       webhook_data: YooKassaWebhook,
       background_tasks: BackgroundTasks,
       db: AsyncSession = Depends(get_db)
   ):
       """–û–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ—Ç –Æ–∫–∞—Å—Å—ã"""
       try:
           logger.info(f"–ü–æ–ª—É—á–µ–Ω webhook: {webhook_data.event}")
           
           # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
           if webhook_data.event != "payment.succeeded":
               return {"status": "ignored"}
           
           payment_id = webhook_data.object.get("id")
           metadata = webhook_data.object.get("metadata", {})
           
           if not payment_id:
               logger.error("Webhook –±–µ–∑ payment_id")
               return {"status": "error", "message": "Missing payment_id"}
           
           # –ò—â–µ–º –ø–ª–∞—Ç–µ–∂ –≤ –Ω–∞—à–µ–π –±–∞–∑–µ
           payment = await db.execute(
               select(Payment).where(Payment.yookassa_payment_id == payment_id)
           ).scalar_one_or_none()
           
           if not payment:
               logger.error(f"–ü–ª–∞—Ç–µ–∂ {payment_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
               return {"status": "error", "message": "Payment not found"}
           
           # –ï—Å–ª–∏ –ø–ª–∞—Ç–µ–∂ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
           if payment.status == "completed":
               logger.info(f"–ü–ª–∞—Ç–µ–∂ {payment_id} —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω")
               return {"status": "already_processed"}
           
           # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞
           await update_payment(db, payment.id, {
               "status": "completed",
               "yookassa_payment_status": "succeeded",
               "payment_date": datetime.utcnow()
           })
           
           # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
           company_id = payment.company_id
           company_result = await db.execute(
               select(Company).where(Company.id == company_id)
           )
           company = company_result.scalar_one_or_none()
           
           if not company:
               logger.error(f"–ö–æ–º–ø–∞–Ω–∏—è {company_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
               return {"status": "error", "message": "Company not found"}
           
           # –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É
           plan_id = metadata.get("plan_id")
           start_date = date.today()
           end_date = start_date + timedelta(days=30)  # 1 –º–µ—Å—è—Ü
           
           subscription = await create_subscription(db, {
               "company_id": company_id,
               "plan_id": plan_id,
               "start_date": start_date,
               "end_date": end_date,
               "status": "active",
               "payment_method": "yookassa"
           })
           
           # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–æ–º–ø–∞–Ω–∏—é
           company.is_active = True
           company.subscription_status = "active"
           company.subscription_end_date = end_date
           company.can_create_bookings = True
           await db.commit()
           
           # –°–æ–∑–¥–∞–µ–º —Å—Ö–µ–º—É –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
           # –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è, –ø–æ—ç—Ç–æ–º—É –¥–µ–ª–∞–µ–º –≤ —Ñ–æ–Ω–µ
           background_tasks.add_task(
               create_company_infrastructure,
               company_id,
               payment_id
           )
           
           logger.info(f"–ö–æ–º–ø–∞–Ω–∏—è {company_id} —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞")
           
           return {"status": "success"}
       
       except Exception as e:
           logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook: {e}", exc_info=True)
           # –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –Æ–∫–∞—Å—Å–∞ –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–ª–∞
           return {"status": "error", "message": "Internal server error"}
   
   async def create_company_infrastructure(company_id: int, payment_id: str):
       """–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏"""
       try:
           # –°–æ–∑–¥–∞–µ–º —Å—Ö–µ–º—É
           schema_name = await TenantService.create_tenant_schema(company_id)
           
           # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
           await TenantService.apply_migrations_to_schema(company_id)
           
           logger.info(f"–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ {company_id} —Å–æ–∑–¥–∞–Ω–∞")
       
       except Exception as e:
           logger.error(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã: {e}", exc_info=True)
           # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω—É
           # ...
   ```

3. –î–æ–±–∞–≤–∏—Ç—å webhook –≤ main.py:
   ```python
   from app.api.public import router as public_router
   
   app.include_router(public_router)
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] Webhook endpoint —Å–æ–∑–¥–∞–Ω
- [ ] –ü–ª–∞—Ç–µ–∂ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- [ ] –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è
- [ ] –ö–æ–º–ø–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
- [ ] –°—Ö–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 4.7: –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –Æ–∫–∞—Å—Å—ã

**–û–ø–∏—Å–∞–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Æ–∫–∞—Å—Å—ã –≤ .env.example.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –û–±–Ω–æ–≤–∏—Ç—å .env.example:
   ```env
   # ==================== YOOKASSA ====================
   YOOKASSA_SHOP_ID=–≤–∞—à_shop_id
   YOOKASSA_SECRET_KEY=–≤–∞—à_secret_key
   YOOKASSA_API_URL=https://api.yookassa.ru/v3/payments
   ```

2. –û–±–Ω–æ–≤–∏—Ç—å bot/config.py:
   ```python
   # YooKassa
   YOOKASSA_SHOP_ID = os.getenv("YOOKASSA_SHOP_ID", "")
   YOOKASSA_SECRET_KEY = os.getenv("YOOKASSA_SECRET_KEY", "")
   YOOKASSA_API_URL = os.getenv("YOOKASSA_API_URL", "https://api.yookassa.ru/v3/payments")
   ```

3. –û–±–Ω–æ–≤–∏—Ç—å web/backend/app/config.py:
   ```python
   from pydantic_settings import BaseSettings
   
   class Settings(BaseSettings):
       # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ...
       
       # YooKassa
       YOOKASSA_SHOP_ID: str = ""
       YOOKASSA_SECRET_KEY: str = ""
       YOOKASSA_API_URL: str = "https://api.yookassa.ru/v3/payments"
       
       class Config:
           env_file = ".env"
   
   settings = Settings()
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] .env.example –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] bot/config.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] web/backend/app/config.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 4.8: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –Æ–∫–∞—Å—Å–æ–π

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ç–µ—Å—Ç–æ–≤—ã–º –º–∞–≥–∞–∑–∏–Ω–æ–º –Æ–∫–∞—Å—Å—ã.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:
   ```
   scripts/test_yookassa.py
   ```

2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç—ã:
   ```python
   import asyncio
   from app.services.yookassa_service import YooKassaService
   from decimal import Decimal
   
   async def test_yookassa():
       """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –Æ–∫–∞—Å—Å–æ–π"""
       print("=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Æ–∫–∞—Å—Å—ã ===\n")
       
       yookassa = YooKassaService()
       
       # –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
       print("1. –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞...")
       try:
           payment = await yookassa.create_payment(
               amount=Decimal("100.00"),
               description="–¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂",
               metadata={"test": True}
           )
           print(f"‚úÖ –ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–Ω: {payment['id']}")
           print(f"   URL: {payment['confirmation']['confirmation_url']}")
           print(f"   –°—Ç–∞—Ç—É—Å: {payment['status']}")
       except Exception as e:
           print(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: {e}")
           return
       
       # –¢–µ—Å—Ç 2: –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
       print("\n2. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...")
       try:
           payment_id = payment['id']
           payment_info = await yookassa.get_payment(payment_id)
           print(f"‚úÖ –ü–ª–∞—Ç–µ–∂ –ø–æ–ª—É—á–µ–Ω: {payment_info}")
       except Exception as e:
           print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: {e}")
       
       # –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏
       print("\n3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook...")
       payload = '{"test": "payload"}'
       signature = "test_signature"
       is_valid = yookassa.verify_webhook_signature(payload, signature)
       print(f"{'‚úÖ –ü–æ–¥–ø–∏—Å—å –≤–∞–ª–∏–¥–Ω–∞' if is_valid else '‚ùå –ü–æ–¥–ø–∏—Å—å –Ω–µ–≤–∞–ª–∏–¥–Ω–∞'}")
       
       print("\n=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ===")
   
   if __name__ == "__main__":
       asyncio.run(test_yookassa())
   ```

3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç:
   ```bash
   docker compose exec web python scripts/test_yookassa.py
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 4.9: –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint:
   ```python
   @router.get("/payment-success")
   async def payment_success():
       """–°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã"""
       html = """
       <!DOCTYPE html>
       <html>
       <head>
           <title>–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞</title>
           <style>
               body {
                   font-family: Arial, sans-serif;
                   display: flex;
                   justify-content: center;
                   align-items: center;
                   height: 100vh;
                   margin: 0;
                   background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
               }
               .container {
                   text-align: center;
                   color: white;
               }
               h1 {
                   font-size: 48px;
                   margin-bottom: 20px;
               }
               p {
                   font-size: 24px;
                   margin-bottom: 30px;
               }
               button {
                   padding: 15px 30px;
                   font-size: 18px;
                   background: white;
                   color: #667eea;
                   border: none;
                   border-radius: 5px;
                   cursor: pointer;
                   text-decoration: none;
               }
               button:hover {
                   background: #f0f0f0;
               }
           </style>
       </head>
       <body>
           <div class="container">
               <h1>‚úÖ</h1>
               <p>–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞!</p>
               <p>–í–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ.</p>
               <button onclick="window.location.href='/'">–ü–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å</button>
           </div>
       </body>
       </html>
       """
       return HTMLResponse(content=html)
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] Endpoint —Å–æ–∑–¥–∞–Ω
- [ ] HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫—Ä–∞—Å–∏–≤–∞—è
- [ ] –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 4.10: –î–æ–±–∞–≤–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ API –≤ main.py

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ API —Ä–æ—É—Ç–µ—Ä—ã –≤ –≥–ª–∞–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –û–±–Ω–æ–≤–∏—Ç—å web/backend/main.py:
   ```python
   from app.api.public import router as public_router
   
   # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–µ API
   app.include_router(public_router)
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –ü—É–±–ª–∏—á–Ω—ã–µ API –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [ ] –î–æ—Å—Ç—É–ø–Ω—ã –ø–æ /api/public/*
- [ ] –†–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç —ç—Ç–∞–ø–∞

### YooKassa —Å–µ—Ä–≤–∏—Å

- [ ] YooKassaService —Å–æ–∑–¥–∞–Ω
- [ ] create_payment —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] get_payment —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] verify_webhook_signature —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—É–±–ª–∏—á–Ω—ã–µ API

- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Webhook –æ—Ç –Æ–∫–∞—Å—Å—ã —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∞

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

- [ ] –ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã
- [ ] –ö–æ–º–ø–∞–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è
- [ ] –°—Ö–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–µ
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] –¢–µ—Å—Ç—ã –Æ–∫–∞—Å—Å—ã –ø—Ä–æ–π–¥–µ–Ω—ã
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞
- [ ] –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞
- [ ] Webhook –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö

### –û–∫—Ä—É–∂–µ–Ω–∏–µ

- [ ] .env.example –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] bot/config.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] web/backend/app/config.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã

---

## ‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ

### –†–∏—Å–∫ 1: –û—à–∏–±–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –Æ–∫–∞—Å—Å–æ–π

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í–ª–∏—è–Ω–∏–µ:** –í—ã—Å–æ–∫–æ–µ

**–ú–µ—Ä—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫

**–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Æ–∫–∞—Å—Å—ã
- –°–≤—è–∑—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –Æ–∫–∞—Å—Å—ã
- –†–µ–∑–µ—Ä–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã

---

### –†–∏—Å–∫ 2: –ü–æ–¥–¥–µ–ª–∫–∞ webhook

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–í–ª–∏—è–Ω–∏–µ:** –í—ã—Å–æ–∫–æ–µ

**–ú–µ—Ä—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhook
- –ü—Ä–æ–≤–µ—Ä–∫–∞ IP –∏—Å—Ç–æ—á–Ω–∏–∫–∞
- –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö

**–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö webhook
- –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

---

### –†–∏—Å–∫ 3: –î–æ–ª–≥–æ–µ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ö–µ–º—ã

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í–ª–∏—è–Ω–∏–µ:** –°—Ä–µ–¥–Ω–µ–µ

**–ú–µ—Ä—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:**
- –§–æ–Ω–æ–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
- –†—É—á–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
   ```bash
   docker compose logs web -f | grep yookassa
   ```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
   ```bash
   docker compose exec web printenv | grep YOOKASSA
   ```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook:
   ```bash
   # –õ–æ–≥–∏ webhook
   docker compose logs web -f | grep webhook
   ```

4. –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–∞:
   ```bash
   # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∫—Ä–∏–ø—Ç
   docker compose exec web python scripts/test_yookassa.py
   ```

---

**–≠—Ç–∞–ø 4 –∑–∞–≤–µ—Ä—à–µ–Ω:** [ ]  
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** _________  
**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:** _________________


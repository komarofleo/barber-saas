# Этап 4: Биллинг и подписки

**Продолжительность:** 3-4 дня  
**Статус:** ⏳ В ожидании  
**Приоритет:** Высокий  

---

## 🎯 Цель

Создать полноценную систему биллинга и управления подписками для мульти-тенантной SaaS платформы Barber.

---

## 📦 Требования

### 1. Функционал

#### ✅ Создание/редактирование/удаление компаний
- Регистрация новой компании через публичный API
- Получение списка компаний с пагинацией
- Получение информации о конкретной компании
- Редактирование информации о компании
- Деактивация компании

#### ✅ Управление тарифными планами (Plan)
- Получение списка всех тарифных планов
- Получение информации о конкретном плане
- Создание новых планов
- Редактирование существующих планов
- Активация/деактивация планов

#### ✅ Создание подписок для компаний (Subscription)
- Создание новой подписки для компании
- Получение списка подписок компании
- Получение информации о конкретной подписке
- Продление подписки
- Отмена подписки

#### ✅ Обработка платежей через Юкассу (Payment)
- Создание записи о платеже
- Получение списка платежей компании
- Получение списка платежей подписки
- Обновление статуса платежа
- Обработка webhook от Юкассы

#### ✅ Webhook уведомления от платежной системы
- Обработка успешного платежа (payment.succeeded) → активация подписки
- Обработка отмены платежа (payment.canceled) → отмена подписки
- Обработка неуспешного платежа (payment.failed) → логирование

#### ✅ Блокировка функционала при истекшей/неактивной подписке
- Автоматическая блокировка создания записей при истекшей/неактивной подписке
- Разблокировка при продлении подписки

#### ✅ Отправка напоминаний о приближающемся окончании подписки
- За 7 дней до окончания → напоминание
- За 3 дня до окончания → напоминание (повторное)

#### ✅ Отправка напоминаний о неоплате
- После окончания подписки → напоминание каждые 3 дня
- Напоминание о необходимости продлить подписку

#### ✅ Статистика платежей для супер-админа
- Общая выручка за месяц
- Количество активных подписок
- Количество истекающих подписок
- Общее количество компаний

### 2. Компоненты

#### Backend API
- ✅ `web/backend/app/api/public.py` - Публичные API
  - `POST /api/public/companies/register` - регистрация новой компании
  - `GET /api/public/plans` - список тарифных планов
  - `GET /api/public/plans/{plan_id}` - детали плана

- ✅ `web/backend/app/api/super_admin.py` - API супер-админа
  - `GET /api/super-admin/dashboard/stats` - статистика по всем компаниям
  - `GET /api/super-admin/companies` - пагинированный список
  - `GET /api/super-admin/companies/{company_id}` - детали компании
  - `GET /api/super-admin/companies/{company_id}/subscriptions` - подписки компании
  - `GET /api/super-admin/companies/{company_id}/payments` - платежи компании
  - `POST /api/super-admin/companies/{company_id}/activate` - активация компании
  - `POST /api/super-admin/companies/{company_id}/deactivate` - деактивация компании

#### Backend Сервисы
- ✅ `web/backend/app/services/company_service.py` - CRUD для Company
- ✅ `web/backend/app/services/subscription_service.py` - CRUD для Subscription
- ✅ `web/backend/app/services/payment_service.py` - CRUD для Payment + Юкасса

#### Модели (public схема)
- ✅ `Company` - компания
- ✅ `Plan` - тарифный план
- ✅ `Subscription` - подписка компании
- ✅ `Payment` - платеж

#### Бот супер-админа (Вариант D)
- 🔄 `bot/super_admin_bot.py` - бот для управления всеми компаниями

### 3. Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                   PUBLIC SCHEMA                        │
│                                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  Company  │   Subscription   │   Payment │
│  └─────────────────────────────────────────────────────┘   │
│                                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                 Super Admin Bot               │   │
│  │          (Вариант D - расширение)           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                           │
│              ┌──────────────────────────────────────────┐  │
│              │     Company Service Layer       │  │
│              │     (company_service,            │  │
│              │      subscription_service,          │  │
│              │      payment_service)              │  │
│              └──────────────────────────────────────┘   │
│                                                           │
│  ┌──────────────────────────────────────────────────┐  │
│  │            Super Admin API Layer        │  │
│  │   (public/, super_admin/)            │  │
│  └───────────────────────────────────────────────┘   │
│                                                           │
│  ┌──────────────────────────────────────────────────┐  │
│  │          Celery Tasks Layer          │  │
│  │     (subscription_notifications.py)    │  │
│  └──────────────────────────────────────────────┘   │
│                                                           │
└─────────────────────────────────────────────────────────────────┘
```

**API слой:**
- Публичные API (`/api/public/*`) - для регистрации клиентов
- API супер-админа (`/api/super-admin/*`) - для управления системой

**Бизнес-логика:**
1. **Регистрация:** Клиент регистрируется → Создается Company → Создается Subscription → Создается Payment через Юкассу
2. **Оплата:** Клиент оплачивает → Webhook уведомление → Subscription активируется → Tenant схема создается
3. **Подписка:** 30 дней активная подписка (по умолчанию)
4. **Блокировка:** За 7 дней до окончания → блокируется создание записей
5. **Напоминания:** Celery задачи → напоминания об окончании и неоплате

---

## 🚀 Реализация

### Шаг 4.1: Расширить сервисы для работы с Company моделью

**Задачи:**
- [ ] Создать `web/backend/app/services/company_service.py`
- [ ] Реализовать CRUD операции для Company
- [ ] Добавить пагинацию для списка компаний
- [ ] Реализовать проверку статуса подписки
- [ ] Добавить методы для активации/деактивации компании

**Требования:**
- Использовать существующие модели `Company`, `Subscription`, `Payment`
- Использовать `get_db()` для public схемы
- Возводить `PlanResponse`, `SubscriptionResponse`, `PaymentResponse`
- Логирование всех операций

### Шаг 4.2: Создать сервис для работы с Subscription моделью

**Задачи:**
- [x] Создать `web/backend/app/services/subscription_service.py`
- [ ] Реализовать CRUD операции для Subscription
- [ ] Добавить методы для создания, продления, отмены подписок
- [ ] Реализовать проверку статуса подписки (active, expired, cancelled)
- [ ] Добавить методы для получения подписки компании
- [ ] Добавить методы для получения истекающих подписок

**Требования:**
- Использовать существующую модель `Subscription`
- Использовать связи с `Company` и `Plan`
- Логировать изменения статуса подписок
- Рассчитывать даты окончания и начала

### Шаг 4.3: Создать сервис для работы с Payment моделью и Юкассой

**Задачи:**
- [x] Создать `web/backend/app/services/payment_service.py`
- [ ] Реализовать CRUD операции для Payment
- [ ] Интегрировать `YooKassaService` для создания платежей
- [ ] Обновлять статус платежей (pending → succeeded/failed/cancelled)
- [ ] Обрабатывать webhook от Юкассы
- [ ] Валидировать подписи webhook

**Требования:**
- Использовать существующую модель `Payment`
- Использовать связи с `Company` и `Subscription`
- Интегрироваться с `YooKassaService`
- Хранить metadata (extra_data) с дополнительной информацией
- Проверять подписи webhook

### Шаг 4.4: Расширить API супер-админа

**Задачи:**
- [ ] `GET /api/super-admin/dashboard/stats` - статистика дэшборда
  - Общая выручка
  - Количество компаний/подписок/платежей
  - Истекающие подписки
- [ ] `GET /api/super-admin/companies` - пагинированный список компаний
  - Фильтры по статусу (active/inactive)
  - Поиск по имени/email
- [ ] `GET /api/super-admin/companies/{company_id}` - детали компании
  - Вся информация о компании
  - Текущая подписка
  - История платежей
  - История подписок
- [ ] `POST /api/super-admin/companies/{company_id}/activate` - активация компании
  - Разблокировка создания записей
- [ ] `POST /api/super-admin/companies/{company_id}/deactivate` - деактивация компании
  - Блокировка создания записей
  - Отправка уведомления

**Требования:**
- Использовать существующие сервисы `company_service`, `subscription_service`, `payment_service`
- Проверять права доступа (только супер-админ)
- Возвращать статистику в нужном формате
- Использовать пагинацию для больших списков

### Шаг 4.5: Реализовать Celery задачи для напоминаний

**Задачи:**
- [ ] Создать `web/backend/app/tasks/subscription_notifications.py`
- [ ] `send_reminder_7_days_before` - напоминание за 7 дней
- [ ] `send_reminder_3_days_before` - напоминание за 3 дня
- [ ] `send_reminder_1_day_before` - напоминание за 1 день
- [ ] `send_reminder_expiration` - напоминание об окончании
- [ ] `send_payment_reminder` - напоминание о неоплате (каждые 3 дня после окончания)
- [ ] Отправка уведомлений через Telegram бота

**Требования:**
- Использовать `Company.telegram_bot_token` для отправки уведомлений
- Использовать `Company.admin_telegram_id` для целевого адреса
- Проверять статус подписки перед отправкой
- Логировать все отправленные уведомления

### Шаг 4.6: Расширить Бот супер-админа (Вариант D)

**Задачи:**
- [x] Расширить `bot/super_admin_bot.py`
- [ ] Добавить команду для просмотра статистики по всем компаниям
- [ ] Добавить команду для просмотра списка компаний с пагинацией
- [ ] Добавить команду для активации/деактивации компании
- [ ] Добавить команду для отправки напоминаний
- [ ] Добавить Inline клавиатуры для навигации
- [ ] Реализовать FSM для управления состоянием

**Требования:**
- Работать с `public` схемой
- Использовать `Company`, `Subscription`, `Payment` модели
- Обеспечить безопасное управление (проверка прав)
- Предоставлять понятный UI

### Шаг 4.7: Тестирование

**Задачи:**
- [ ] Unit тесты для `company_service`
- [ ] Unit тесты для `subscription_service`
- [ ] Unit тесты для `payment_service`
- [ ] Интеграционные тесты для API
- [ ] Тестирование webhook уведомлений
- [ ] Тестирование Celery задач

**Требования:**
- Использовать `pytest` и `pytest-asyncio`
- Покрытие основных сценариев
- Тестирование изоляции данных (public схемы не должны смешиваться)

---

## 📝 Чек-лист завершения

### Шаг 4.1: Расширение сервисов для работы с Company моделью
- [x] Создать `web/backend/app/services/company_service.py`
- [x] Реализовать CRUD операции для Company
- [x] Добавить пагинацию для списка компаний
- [x] Реализовать проверку статуса подписки
- [x] Добавить методы для активации/деактивации компании

### Шаг 4.2: Создать сервис для работы с Subscription моделью
- [x] Создать `web/backend/app/services/subscription_service.py`
- [x] Реализовать CRUD операции для Subscription
- [x] Добавить методы для создания, продления, отмены подписок
- [x] Реализовать проверку статуса подписки
- [x] Добавить методы для получения подписки компании
- [x] Добавить методы для получения истекающих подписок

### Шаг 4.3: Создать сервис для работы с Payment моделью и Юкассой
- [x] Создать `web/backend/app/services/payment_service.py`
- [x] Реализовать CRUD операции для Payment
- [x] Интегрировать `YooKassaService` для создания платежей
- [x] Обновлять статус платежей (pending → succeeded/failed/cancelled)
- [x] Обрабатывать webhook от Юкассы
- [x] Валидировать подписи webhook

### Шаг 4.4: Расширить API супер-админа
- [ ] `GET /api/super-admin/dashboard/stats` - статистика дэшборда
- [ ] `GET /api/super-admin/companies` - пагинированный список компаний
- [ ] `GET /api/super-admin/companies/{company_id}` - детали компании
- [ ] `POST /api/super-admin/companies/{company_id}/activate` - активация компании
- [ ] `POST /api/super-admin/companies/{company_id}/deactivate` - деактивация компании

### Шаг 4.5: Реализовать Celery задачи для напоминаний
- [ ] Создать `web/backend/app/tasks/subscription_notifications.py`
- [ ] `send_reminder_7_days_before` - напоминание за 7 дней
- [ ] `send_reminder_3_days_before` - напоминание за 3 дня
- [ ] `send_reminder_1_day_before` - напоминание за 1 день
- [ ] `send_reminder_expiration` - напоминание об окончании
- [ ] `send_payment_reminder` - напоминание о неоплате

### Шаг 4.6: Расширить Бот супер-админа (Вариант D)
- [x] Расширить `bot/super_admin_bot.py`
- [ ] Добавить команду для просмотра статистики по всем компаниям
- [ ] Добавить команду для просмотра списка компаний с пагинацией
- [ ] Добавить команду для активации/деактивации компании
- [ ] Добавить команду для отправки напоминаний

### Шаг 4.7: Тестирование
- [ ] Unit тесты для `company_service`
- [ ] Unit тесты для `subscription_service`
- [ ] Unit тесты для `payment_service`
- [ ] Интеграционные тесты для API
- [ ] Тестирование webhook уведомлений
- [ ] Тестирование Celery задач

---

## 📊 План работ

### День 1
- Утро: Разработка сервисов
- День: Реализация API супер-админа
- Вечер: Тестирование

### День 2
- Утро: Celery задачи
- День: Расширение бота супер-админа
- Вечер: Интеграционное тестирование

### День 3
- Утро: Unit тесты
- День: Интеграционные тесты (E2E, нагрузочные)
- Вечер: Фикс багов

---

## 🎯 Ожидаемые результаты

- Полноценная система биллинга и подписок
- Автоматическая блокировка при истекшей подписке
- Напоминания о приближающемся окончании
- Статистика для супер-админа
- Удобное управление через бота супер-админа

---

**Примечание:** Большая часть сервисов уже создана в предыдущих этапах (1-3). Этот этап фокусируется на расширении функционала и интеграции.


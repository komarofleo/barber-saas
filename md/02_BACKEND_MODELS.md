# –≠—Ç–∞–ø 2: Backend - –ú–æ–¥–µ–ª–∏ –∏ –°—Ö–µ–º—ã

**–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 2-3 –¥–Ω—è  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω (—Å–º. `STAGE_2_COMPLETE.md`)  
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2026-01-06  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–¶–µ–ª—å —ç—Ç–∞–ø–∞](#—Ü–µ–ª—å-—ç—Ç–∞–ø–∞)
2. [–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è](#–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
3. [–ü–æ–¥–∑–∞–¥–∞—á–∏](#–ø–æ–¥–∑–∞–¥–∞—á–∏)
4. [–ß–µ–∫-–ª–∏—Å—Ç —ç—Ç–∞–ø–∞](#—á–µ–∫-–ª–∏—Å—Ç-—ç—Ç–∞–ø–∞)
5. [–†–∏—Å–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ](#—Ä–∏—Å–∫–∏-–∏-–∏—Ö-—Ä–µ—à–µ–Ω–∏–µ)

---

## üéØ –¶–µ–ª—å —ç—Ç–∞–ø–∞

–°–æ–∑–¥–∞—Ç—å SQLAlchemy –º–æ–¥–µ–ª–∏ –∏ Pydantic —Å—Ö–µ–º—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏—è–º–∏, –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏.

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

- –í—Å–µ –Ω–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- –í—Å–µ Pydantic —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã –∏ –≤–∞–ª–∏–¥–Ω—ã
- CRUD —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–µ–ª—è–º–∏
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
- –°–æ–∑–¥–∞–Ω–∏–µ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞

---

## üîß –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã

- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏–∑ —ç—Ç–∞–ø–∞ 1 –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- [ ] –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã
- [ ] SQLAlchemy 2.0 –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Pydantic —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.11+ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- –î–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–Ω–∏–º–∞–Ω–∏–µ SQLAlchemy ORM

---

## üìù –ü–æ–¥–∑–∞–¥–∞—á–∏

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.1: –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å Company

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å SQLAlchemy –º–æ–¥–µ–ª—å –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã companies.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/models/company.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–¥–µ–ª—å:
   ```python
   from sqlalchemy import Column, Integer, String, Boolean, Date, DateTime, BigInteger, Text, Index
   from sqlalchemy.dialects.postgresql import JSONB
   from sqlalchemy.ext.declarative import declarative_base
   from datetime import datetime
   from sqlalchemy.orm import relationship

   Base = declarative_base()

   class Company(Base):
       """–°–∞–ª–æ–Ω—ã –∫—Ä–∞—Å–æ—Ç—ã (–∫–æ–º–ø–∞–Ω–∏–∏)"""
       __tablename__ = "companies"
       
       id = Column(Integer, primary_key=True, index=True)
       name = Column(String(255), nullable=False)
       code = Column(String(50), unique=True, nullable=False, index=True)
       email = Column(String(255), nullable=True)
       phone = Column(String(20), nullable=True)
       telegram_bot_token = Column(String(500), unique=True, nullable=True, index=True)
       telegram_bot_username = Column(String(255), nullable=True)
       webhook_url = Column(String(500), nullable=True)
       created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
       updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
       is_active = Column(Boolean, default=True, nullable=False)
       subscription_status = Column(String(50), default='trial', nullable=False, index=True)
       subscription_end_date = Column(Date, nullable=True)
       max_users = Column(Integer, nullable=True)
       max_masters = Column(Integer, nullable=True)
       max_posts = Column(Integer, nullable=True)
       can_create_bookings = Column(Boolean, default=True, nullable=False)
       features = Column(JSONB, default={}, nullable=False)
       
       # Relationships
       subscriptions = relationship("Subscription", back_populates="company", cascade="all, delete-orphan")
       payments = relationship("Payment", back_populates="company", cascade="all, delete-orphan")
       users = relationship("User", back_populates="company")
   ```

3. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã:
   - `idx_companies_code`
   - `idx_companies_subscription_status`
   - `idx_companies_is_active`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞
- [ ] –í—Å–µ –ø–æ–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [ ] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] Relationships –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [ ] –ú–æ–¥–µ–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.2: –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å Plan

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å SQLAlchemy –º–æ–¥–µ–ª—å –¥–ª—è —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/models/plan.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–¥–µ–ª—å:
   ```python
   from sqlalchemy import Column, Integer, String, Numeric, Boolean, DateTime, Index
   from sqlalchemy.dialects.postgresql import JSONB
   from datetime import datetime
   from sqlalchemy.orm import relationship

   class Plan(Base):
       """–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã"""
       __tablename__ = "plans"
       
       id = Column(Integer, primary_key=True, index=True)
       name = Column(String(50), unique=True, nullable=False)
       price_monthly = Column(Numeric(10, 2), nullable=False)
       max_users = Column(Integer, nullable=False)
       max_masters = Column(Integer, nullable=False)
       max_posts = Column(Integer, nullable=False)
       max_bookings_per_day = Column(Integer, nullable=False)
       features = Column(JSONB, default={}, nullable=False)
       is_active = Column(Boolean, default=True, nullable=False, index=True)
       created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
       
       # Relationships
       subscriptions = relationship("Subscription", back_populates="plan")
   ```

3. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã:
   - `idx_plans_active`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞
- [ ] –í—Å–µ –ø–æ–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [ ] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] Relationships –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [ ] –ú–æ–¥–µ–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.3: –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å Subscription

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å SQLAlchemy –º–æ–¥–µ–ª—å –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/models/subscription.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–¥–µ–ª—å:
   ```python
   from sqlalchemy import Column, Integer, String, Date, DateTime, Boolean, ForeignKey, Index
   from datetime import datetime, date
   from sqlalchemy.orm import relationship

   class Subscription(Base):
       """–ü–æ–¥–ø–∏—Å–∫–∏"""
       __tablename__ = "subscriptions"
       
       id = Column(Integer, primary_key=True, index=True)
       company_id = Column(Integer, ForeignKey("companies.id", ondelete="CASCADE"), nullable=False, index=True)
       plan_id = Column(Integer, ForeignKey("plans.id"), nullable=True)
       start_date = Column(Date, nullable=False)
       end_date = Column(Date, nullable=False)
       status = Column(String(50), default='active', nullable=False, index=True)
       auto_renewal = Column(Boolean, default=False, nullable=False)
       payment_method = Column(String(50), nullable=True)
       yookassa_payment_id = Column(String(255), nullable=True)
       created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
       
       # Relationships
       company = relationship("Company", back_populates="subscriptions")
       plan = relationship("Plan", back_populates="subscriptions")
       payments = relationship("Payment", back_populates="subscription")
   ```

3. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã:
   - `idx_subscriptions_company`
   - `idx_subscriptions_status`
   - `idx_subscriptions_end_date`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞
- [ ] –í—Å–µ –ø–æ–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [ ] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] Foreign keys –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [ ] Relationships –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [ ] –ú–æ–¥–µ–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.4: –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å Payment

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å SQLAlchemy –º–æ–¥–µ–ª—å –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/models/payment.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–¥–µ–ª—å:
   ```python
   from sqlalchemy import Column, Integer, String, Numeric, DateTime, ForeignKey, Index
   from sqlalchemy.dialects.postgresql import JSONB
   from datetime import datetime
   from sqlalchemy.orm import relationship

   class Payment(Base):
       """–ü–ª–∞—Ç–µ–∂–∏"""
       __tablename__ = "payments"
       
       id = Column(Integer, primary_key=True, index=True)
       company_id = Column(Integer, ForeignKey("companies.id", ondelete="CASCADE"), nullable=False, index=True)
       subscription_id = Column(Integer, ForeignKey("subscriptions.id", ondelete="SET NULL"), nullable=True)
       amount = Column(Numeric(10, 2), nullable=False)
       currency = Column(String(3), default='RUB', nullable=False)
       payment_date = Column(DateTime, nullable=True, index=True)
       payment_method = Column(String(50), nullable=True)
       yookassa_payment_id = Column(String(255), unique=True, nullable=True, index=True)
       yookassa_payment_status = Column(String(50), nullable=True)
       status = Column(String(50), default='pending', nullable=False, index=True)
       receipt_url = Column(String(500), nullable=True)
       metadata = Column(JSONB, default={}, nullable=False)
       created_at = Column(DateTime, default=datetime.utcnow, nullable=False, index=True)
       
       # Relationships
       company = relationship("Company", back_populates="payments")
       subscription = relationship("Subscription", back_populates="payments")
   ```

3. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã:
   - `idx_payments_company`
   - `idx_payments_status`
   - `idx_payments_payment_date`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞
- [ ] –í—Å–µ –ø–æ–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [ ] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] Foreign keys –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [ ] Relationships –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [ ] –ú–æ–¥–µ–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.5: –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å SuperAdmin

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å SQLAlchemy –º–æ–¥–µ–ª—å –¥–ª—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–≤.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/models/super_admin.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–¥–µ–ª—å:
   ```python
   from sqlalchemy import Column, Integer, String, BigInteger, DateTime, Index
   from datetime import datetime

   class SuperAdmin(Base):
       """–°—É–ø–µ—Ä-–∞–¥–º–∏–Ω—ã"""
       __tablename__ = "super_admins"
       
       id = Column(Integer, primary_key=True, index=True)
       telegram_id = Column(BigInteger, unique=True, nullable=False, index=True)
       email = Column(String(255), unique=True, nullable=True)
       name = Column(String(255), nullable=True)
       created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
   ```

3. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã:
   - `idx_super_admins_telegram`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –ú–æ–¥–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞
- [ ] –í—Å–µ –ø–æ–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [ ] –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ú–æ–¥–µ–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.6: –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å User –¥–ª—è —Å–≤—è–∑–∏ —Å Company

**–û–ø–∏—Å–∞–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ company_id –≤ –º–æ–¥–µ–ª—å User.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª:
   ```
   shared/database/models.py
   ```

2. –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å User:
   ```python
   class User(Base):
       """–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã"""
       __tablename__ = "users"
       
       id = Column(Integer, primary_key=True, index=True)
       telegram_id = Column(BigInteger, unique=True, nullable=False, index=True)
       username = Column(String(255), nullable=True)
       first_name = Column(String(255), nullable=True)
       last_name = Column(String(255), nullable=True)
       phone = Column(String(20), nullable=True, index=True)
       
       # –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ –¥–ª—è —Å–≤—è–∑–∏ —Å –∫–æ–º–ø–∞–Ω–∏–µ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
       # company_id = Column(Integer, ForeignKey("companies.id", ondelete="SET NULL"), nullable=True)
       
       is_admin = Column(Boolean, default=False, nullable=False)
       is_master = Column(Boolean, default=False, nullable=False)
       is_blocked = Column(Boolean, default=False, nullable=False)
       created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
       updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow, nullable=False)
       
       # Relationships
       client = relationship("Client", back_populates="user", uselist=False, cascade="all, delete-orphan")
       master = relationship("Master", back_populates="user", uselist=False, cascade="all, delete-orphan")
       bookings_created = relationship("Booking", foreign_keys="Booking.created_by", back_populates="creator")
       booking_history = relationship("BookingHistory", back_populates="changed_by_user")
       notifications = relationship("Notification", back_populates="user")
       broadcasts_created = relationship("Broadcast", back_populates="creator")
       blocked_slots_created = relationship("BlockedSlot", back_populates="creator")
       
       # –î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å —Å –∫–æ–º–ø–∞–Ω–∏–µ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
       # company = relationship("Company", back_populates="users")
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –ú–æ–¥–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –ü–æ–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- [ ] Relationships –æ–±–Ω–æ–≤–ª–µ–Ω—ã
- [ ] –ú–æ–¥–µ–ª—å –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.7: –°–æ–∑–¥–∞—Ç—å Pydantic —Å—Ö–µ–º—ã –¥–ª—è Company

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å Pydantic —Å—Ö–µ–º—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/schemas/company.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ö–µ–º—ã:
   ```python
   from pydantic import BaseModel, EmailStr, Field, validator
   from typing import Optional, Dict, Any
   from datetime import date, datetime
   
   class CompanyBase(BaseModel):
       """–ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ –∫–æ–º–ø–∞–Ω–∏–∏"""
       name: str = Field(..., min_length=3, max_length=255, description="–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã")
       email: Optional[EmailStr] = Field(None, description="Email")
       phone: Optional[str] = Field(None, max_length=20, description="–¢–µ–ª–µ—Ñ–æ–Ω")
       telegram_bot_token: Optional[str] = Field(None, max_length=500, description="–¢–æ–∫–µ–Ω –±–æ—Ç–∞")
       telegram_bot_username: Optional[str] = Field(None, max_length=255, description="–ò–º—è –±–æ—Ç–∞")
   
   class CompanyCreate(CompanyBase):
       """–°—Ö–µ–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏"""
       code: str = Field(..., min_length=3, max_length=50, description="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –∫–æ–º–ø–∞–Ω–∏–∏")
   
   class CompanyUpdate(BaseModel):
       """–°—Ö–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏"""
       name: Optional[str] = Field(None, min_length=3, max_length=255)
       email: Optional[EmailStr] = None
       phone: Optional[str] = Field(None, max_length=20)
       telegram_bot_token: Optional[str] = Field(None, max_length=500)
       telegram_bot_username: Optional[str] = Field(None, max_length=255)
       webhook_url: Optional[str] = Field(None, max_length=500)
       is_active: Optional[bool] = None
       subscription_status: Optional[str] = Field(None, max_length=50)
       subscription_end_date: Optional[date] = None
       max_users: Optional[int] = Field(None, ge=1)
       max_masters: Optional[int] = Field(None, ge=1)
       max_posts: Optional[int] = Field(None, ge=1)
       can_create_bookings: Optional[bool] = None
       features: Optional[Dict[str, Any]] = None
   
   class CompanyResponse(CompanyBase):
       """–°—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ –∫–æ–º–ø–∞–Ω–∏–∏"""
       id: int
       code: str
       created_at: datetime
       updated_at: datetime
       is_active: bool
       subscription_status: str
       subscription_end_date: Optional[date]
       max_users: Optional[int]
       max_masters: Optional[int]
       max_posts: Optional[int]
       can_create_bookings: bool
       features: Optional[Dict[str, Any]]
       
       class Config:
           from_attributes = True
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –í—Å–µ —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –û–ø–∏—Å–∞–Ω–∏—è –ø–æ–ª–µ–π –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [ ] –°—Ö–µ–º—ã —Ç–µ—Å—Ç–∏—Ä—É—é—Ç—Å—è

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.8: –°–æ–∑–¥–∞—Ç—å Pydantic —Å—Ö–µ–º—ã –¥–ª—è Plan

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å Pydantic —Å—Ö–µ–º—ã –¥–ª—è —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/schemas/plan.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ö–µ–º—ã:
   ```python
   from pydantic import BaseModel, Field
   from typing import Optional, Dict, Any
   from datetime import datetime
   from decimal import Decimal
   
   class PlanBase(BaseModel):
       """–ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ —Ç–∞—Ä–∏—Ñ–Ω–æ–≥–æ –ø–ª–∞–Ω–∞"""
       name: str = Field(..., min_length=3, max_length=50)
       price_monthly: Decimal = Field(..., gt=0, description="–¶–µ–Ω–∞ –≤ –º–µ—Å—è—Ü")
       max_users: int = Field(..., ge=1, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")
       max_masters: int = Field(..., ge=1, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∞—Å—Ç–µ—Ä–æ–≤")
       max_posts: int = Field(..., ge=1, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤")
       max_bookings_per_day: int = Field(..., ge=1, description="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –¥–µ–Ω—å")
       features: Optional[Dict[str, Any]] = Field(default={}, description="–§–∏—á–∏ —Ç–∞—Ä–∏—Ñ–∞")
   
   class PlanCreate(PlanBase):
       """–°—Ö–µ–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞—Ä–∏—Ñ–Ω–æ–≥–æ –ø–ª–∞–Ω–∞"""
       pass
   
   class PlanUpdate(BaseModel):
       """–°—Ö–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞—Ä–∏—Ñ–Ω–æ–≥–æ –ø–ª–∞–Ω–∞"""
       name: Optional[str] = Field(None, min_length=3, max_length=50)
       price_monthly: Optional[Decimal] = Field(None, gt=0)
       max_users: Optional[int] = Field(None, ge=1)
       max_masters: Optional[int] = Field(None, ge=1)
       max_posts: Optional[int] = Field(None, ge=1)
       max_bookings_per_day: Optional[int] = Field(None, ge=1)
       features: Optional[Dict[str, Any]] = None
       is_active: Optional[bool] = None
   
   class PlanResponse(PlanBase):
       """–°—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ —Ç–∞—Ä–∏—Ñ–Ω–æ–≥–æ –ø–ª–∞–Ω–∞"""
       id: int
       is_active: bool
       created_at: datetime
       
       class Config:
           from_attributes = True
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –í—Å–µ —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Decimal —Ç–∏–ø—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- [ ] –°—Ö–µ–º—ã —Ç–µ—Å—Ç–∏—Ä—É—é—Ç—Å—è

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.9: –°–æ–∑–¥–∞—Ç—å Pydantic —Å—Ö–µ–º—ã –¥–ª—è Subscription

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å Pydantic —Å—Ö–µ–º—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/schemas/subscription.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ö–µ–º—ã:
   ```python
   from pydantic import BaseModel, Field
   from typing import Optional
   from datetime import date, datetime
   
   class SubscriptionBase(BaseModel):
       """–ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ –ø–æ–¥–ø–∏—Å–∫–∏"""
       company_id: int = Field(..., ge=1)
       plan_id: int = Field(..., ge=1)
       start_date: date = Field(..., description="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—Å–∫–∏")
       end_date: date = Field(..., description="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏")
       auto_renewal: bool = Field(default=False, description="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ")
       payment_method: Optional[str] = Field(None, max_length=50, description="–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã")
   
   class SubscriptionCreate(SubscriptionBase):
       """–°—Ö–µ–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏"""
       pass
   
   class SubscriptionUpdate(BaseModel):
       """–°—Ö–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏"""
       status: Optional[str] = Field(None, max_length=50)
       auto_renewal: Optional[bool] = None
       payment_method: Optional[str] = Field(None, max_length=50)
   
   class SubscriptionResponse(SubscriptionBase):
       """–°—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ–¥–ø–∏—Å–∫–∏"""
       id: int
       status: str
       yookassa_payment_id: Optional[str]
       created_at: datetime
       
       class Config:
           from_attributes = True
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –í—Å–µ —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –î–∞—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- [ ] –°—Ö–µ–º—ã —Ç–µ—Å—Ç–∏—Ä—É—é—Ç—Å—è

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.10: –°–æ–∑–¥–∞—Ç—å Pydantic —Å—Ö–µ–º—ã –¥–ª—è Payment

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å Pydantic —Å—Ö–µ–º—ã –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/schemas/payment.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ö–µ–º—ã:
   ```python
   from pydantic import BaseModel, Field
   from typing import Optional, Dict, Any
   from datetime import datetime
   from decimal import Decimal
   
   class PaymentBase(BaseModel):
       """–ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ –ø–ª–∞—Ç–µ–∂–∞"""
       company_id: int = Field(..., ge=1)
       subscription_id: Optional[int] = Field(None, ge=1)
       amount: Decimal = Field(..., gt=0, description="–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞")
       currency: str = Field(default="RUB", max_length=3)
       payment_method: Optional[str] = Field(None, max_length=50)
   
   class PaymentCreate(PaymentBase):
       """–°—Ö–µ–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞"""
       pass
   
   class PaymentUpdate(BaseModel):
       """–°—Ö–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞"""
       status: Optional[str] = Field(None, max_length=50)
       yookassa_payment_status: Optional[str] = Field(None, max_length=50)
       payment_date: Optional[datetime] = None
       receipt_url: Optional[str] = Field(None, max_length=500)
   
   class PaymentResponse(PaymentBase):
       """–°—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞"""
       id: int
       yookassa_payment_id: Optional[str]
       yookassa_payment_status: Optional[str]
       status: str
       payment_date: Optional[datetime]
       receipt_url: Optional[str]
       metadata: Optional[Dict[str, Any]]
       created_at: datetime
       
       class Config:
           from_attributes = True
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –í—Å–µ —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Decimal —Ç–∏–ø—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- [ ] –°—Ö–µ–º—ã —Ç–µ—Å—Ç–∏—Ä—É—é—Ç—Å—è

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.11: –°–æ–∑–¥–∞—Ç—å Pydantic —Å—Ö–µ–º—ã –¥–ª—è SuperAdmin

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å Pydantic —Å—Ö–µ–º—ã –¥–ª—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–æ–≤.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/schemas/super_admin.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ö–µ–º—ã:
   ```python
   from pydantic import BaseModel, EmailStr, Field
   from typing import Optional
   from datetime import datetime
   
   class SuperAdminBase(BaseModel):
       """–ë–∞–∑–æ–≤–∞—è —Å—Ö–µ–º–∞ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞"""
       telegram_id: int = Field(..., gt=0, description="Telegram ID")
       email: Optional[EmailStr] = Field(None, description="Email")
       name: Optional[str] = Field(None, max_length=255, description="–ò–º—è")
   
   class SuperAdminCreate(SuperAdminBase):
       """–°—Ö–µ–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞"""
       pass
   
   class SuperAdminUpdate(BaseModel):
       """–°—Ö–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞"""
       email: Optional[EmailStr] = None
       name: Optional[str] = Field(None, max_length=255)
   
   class SuperAdminResponse(SuperAdminBase):
       """–°—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞"""
       id: int
       created_at: datetime
       
       class Config:
           from_attributes = True
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –í—Å–µ —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –í–∞–ª–∏–¥–∞—Ç–æ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] Telegram ID –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- [ ] –°—Ö–µ–º—ã —Ç–µ—Å—Ç–∏—Ä—É—é—Ç—Å—è

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.12: –°–æ–∑–¥–∞—Ç—å CRUD —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è Company

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å CRUD —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–º–ø–∞–Ω–∏—è–º–∏.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/services/company_service.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏:
   ```python
   from sqlalchemy.ext.asyncio import AsyncSession
   from sqlalchemy import select, and_
   from typing import Optional, List
   from datetime import date, datetime
   
   from app.models.company import Company
   
   async def get_company_by_id(session: AsyncSession, company_id: int) -> Optional[Company]:
       """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é –ø–æ ID"""
       result = await session.execute(
           select(Company).where(Company.id == company_id)
       )
       return result.scalar_one_or_none()
   
   async def get_company_by_code(session: AsyncSession, code: str) -> Optional[Company]:
       """–ü–æ–ª—É—á–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é –ø–æ –∫–æ–¥—É"""
       result = await session.execute(
           select(Company).where(Company.code == code)
       )
       return result.scalar_one_or_none()
   
   async def get_companies(
       session: AsyncSession,
       skip: int = 0,
       limit: int = 100,
       is_active: Optional[bool] = None,
       subscription_status: Optional[str] = None
   ) -> List[Company]:
       """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏"""
       query = select(Company)
       
       conditions = []
       if is_active is not None:
           conditions.append(Company.is_active == is_active)
       if subscription_status is not None:
           conditions.append(Company.subscription_status == subscription_status)
       
       if conditions:
           query = query.where(and_(*conditions))
       
       query = query.offset(skip).limit(limit).order_by(Company.created_at.desc())
       result = await session.execute(query)
       return list(result.scalars().all())
   
   async def count_companies(
       session: AsyncSession,
       is_active: Optional[bool] = None,
       subscription_status: Optional[str] = None
   ) -> int:
       """–ü–æ—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π"""
       from sqlalchemy import func
       
       query = select(func.count(Company.id))
       
       conditions = []
       if is_active is not None:
           conditions.append(Company.is_active == is_active)
       if subscription_status is not None:
           conditions.append(Company.subscription_status == subscription_status)
       
       if conditions:
           query = query.where(and_(*conditions))
       
       result = await session.execute(query)
       return result.scalar() or 0
   
   async def create_company(session: AsyncSession, company_data: dict) -> Company:
       """–°–æ–∑–¥–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é"""
       company = Company(**company_data)
       session.add(company)
       await session.commit()
       await session.refresh(company)
       return company
   
   async def update_company(
       session: AsyncSession,
       company_id: int,
       company_data: dict
   ) -> Optional[Company]:
       """–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é"""
       company = await get_company_by_id(session, company_id)
       if not company:
           return None
       
       for field, value in company_data.items():
           if hasattr(company, field):
               setattr(company, field, value)
       
       company.updated_at = datetime.utcnow()
       await session.commit()
       await session.refresh(company)
       return company
   
   async def delete_company(session: AsyncSession, company_id: int) -> bool:
       """–£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é"""
       company = await get_company_by_id(session, company_id)
       if not company:
           return False
       
       await session.delete(company)
       await session.commit()
       return True
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –§–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –§—É–Ω–∫—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä—É—é—Ç—Å—è

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.13: –°–æ–∑–¥–∞—Ç—å CRUD —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è Subscription

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å CRUD —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/services/subscription_service.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ company_service.py):
   - `get_subscription_by_id`
   - `get_subscriptions_by_company`
   - `create_subscription`
   - `update_subscription`
   - `delete_subscription`
   - `get_active_subscription`
   - `get_expiring_subscriptions`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –§—É–Ω–∫—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä—É—é—Ç—Å—è

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.14: –°–æ–∑–¥–∞—Ç—å CRUD —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è Payment

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å CRUD —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/services/payment_service.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏:
   - `get_payment_by_id`
   - `get_payments_by_company`
   - `create_payment`
   - `update_payment`
   - `get_payments_with_stats`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è
- [ ] –§—É–Ω–∫—Ü–∏–∏ —Ç–µ—Å—Ç–∏—Ä—É—é—Ç—Å—è

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.15: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   scripts/init_plans.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ª–æ–≥–∏–∫—É:
   ```python
   import asyncio
   from sqlalchemy.ext.asyncio import AsyncSession
   from app.database import get_db
   from app.models.plan import Plan
   
   async def init_plans():
       """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤"""
       async for session in get_db():
           plans_data = [
               {
                   "name": "Starter",
                   "price_monthly": 2990.00,
                   "max_users": 100,
                   "max_masters": 3,
                   "max_posts": 2,
                   "max_bookings_per_day": 20,
                   "features": {
                       "notifications": True,
                       "statistics": False,
                       "export": False,
                       "promocodes": False
                   }
               },
               {
                   "name": "Pro",
                   "price_monthly": 4990.00,
                   "max_users": 500,
                   "max_masters": 10,
                   "max_posts": 5,
                   "max_bookings_per_day": 50,
                   "features": {
                       "notifications": True,
                       "statistics": True,
                       "export": True,
                       "promocodes": True,
                       "broadcasts": False
                   }
               },
               {
                   "name": "Business",
                   "price_monthly": 9990.00,
                   "max_users": 9999,
                   "max_masters": 9999,
                   "max_posts": 9999,
                   "max_bookings_per_day": 9999,
                   "features": {
                       "notifications": True,
                       "statistics": True,
                       "export": True,
                       "promocodes": True,
                       "broadcasts": True,
                       "api_access": True
                   }
               }
           ]
           
           for plan_data in plans_data:
               # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–ª–∞–Ω
               existing_plan = await session.execute(
                   select(Plan).where(Plan.name == plan_data["name"])
               ).scalar_one_or_none()
               
               if not existing_plan:
                   plan = Plan(**plan_data, is_active=True)
                   session.add(plan)
                   print(f"–°–æ–∑–¥–∞–Ω –ø–ª–∞–Ω: {plan_data['name']}")
               else:
                   print(f"–ü–ª–∞–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: {plan_data['name']}")
           
           await session.commit()
           print("‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–ª–∞–Ω–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!")
   
   if __name__ == "__main__":
       asyncio.run(init_plans())
   ```

3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç:
   ```bash
   docker compose exec web python scripts/init_plans.py
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω
- [ ] –¢—Ä–∏ –ø–ª–∞–Ω–∞ —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 2.16: –°–æ–∑–¥–∞—Ç—å —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   scripts/init_super_admin.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ª–æ–≥–∏–∫—É:
   ```python
   import asyncio
   import sys
   from sqlalchemy.ext.asyncio import AsyncSession
   from app.database import get_db
   from app.models.super_admin import SuperAdmin
   
   async def create_super_admin(telegram_id: int, email: str = None, name: str = None):
       """–°–æ–∑–¥–∞–Ω–∏–µ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞"""
       async for session in get_db():
           # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∂–µ
           existing = await session.execute(
               select(SuperAdmin).where(SuperAdmin.telegram_id == telegram_id)
           ).scalar_one_or_none()
           
           if existing:
               print(f"‚ö†Ô∏è –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω —Å Telegram ID {telegram_id} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
               return existing
           
           # –°–æ–∑–¥–∞–µ–º
           super_admin = SuperAdmin(
               telegram_id=telegram_id,
               email=email,
               name=name
           )
           session.add(super_admin)
           await session.commit()
           await session.refresh(super_admin)
           
           print(f"‚úÖ –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω —Å–æ–∑–¥–∞–Ω:")
           print(f"   Telegram ID: {super_admin.telegram_id}")
           print(f"   Email: {super_admin.email}")
           print(f"   –ò–º—è: {super_admin.name}")
           
           return super_admin
   
   if __name__ == "__main__":
       if len(sys.argv) < 2:
           print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python init_super_admin.py <telegram_id> [email] [name]")
           sys.exit(1)
       
       telegram_id = int(sys.argv[1])
       email = sys.argv[2] if len(sys.argv) > 2 else None
       name = sys.argv[3] if len(sys.argv) > 3 else None
       
       asyncio.run(create_super_admin(telegram_id, email, name))
   ```

3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç:
   ```bash
   docker compose exec web python scripts/init_super_admin.py 329621295 admin@example.com "Super Admin"
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω
- [ ] –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω —Å–æ–∑–¥–∞–Ω
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç —ç—Ç–∞–ø–∞

### SQLAlchemy –º–æ–¥–µ–ª–∏

- [ ] –ú–æ–¥–µ–ª—å Company —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ú–æ–¥–µ–ª—å Plan —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ú–æ–¥–µ–ª—å Subscription —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ú–æ–¥–µ–ª—å Payment —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ú–æ–¥–µ–ª—å SuperAdmin —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ú–æ–¥–µ–ª—å User –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –í—Å–µ relationships –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
- [ ] –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã

### Pydantic —Å—Ö–µ–º—ã

- [ ] –°—Ö–µ–º—ã –¥–ª—è Company —Å–æ–∑–¥–∞–Ω—ã
- [ ] –°—Ö–µ–º—ã –¥–ª—è Plan —Å–æ–∑–¥–∞–Ω—ã
- [ ] –°—Ö–µ–º—ã –¥–ª—è Subscription —Å–æ–∑–¥–∞–Ω—ã
- [ ] –°—Ö–µ–º—ã –¥–ª—è Payment —Å–æ–∑–¥–∞–Ω—ã
- [ ] –°—Ö–µ–º—ã –¥–ª—è SuperAdmin —Å–æ–∑–¥–∞–Ω—ã
- [ ] –í—Å–µ –≤–∞–ª–∏–¥–∞—Ç–æ—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –í—Å–µ —Å—Ö–µ–º—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã

### CRUD —Ñ—É–Ω–∫—Ü–∏–∏

- [ ] CRUD –¥–ª—è Company —Å–æ–∑–¥–∞–Ω
- [ ] CRUD –¥–ª—è Subscription —Å–æ–∑–¥–∞–Ω
- [ ] CRUD –¥–ª—è Payment —Å–æ–∑–¥–∞–Ω
- [ ] –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ
- [ ] –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

- [ ] –°–∫—Ä–∏–ø—Ç init_plans.py —Å–æ–∑–¥–∞–Ω
- [ ] –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –°–∫—Ä–∏–ø—Ç init_super_admin.py —Å–æ–∑–¥–∞–Ω
- [ ] –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω —Å–æ–∑–¥–∞–Ω

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] –ú–æ–¥–µ–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –ë–î
- [ ] –°—Ö–µ–º—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç –¥–∞–Ω–Ω—ã–µ
- [ ] CRUD —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö

---

## ‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ

### –†–∏—Å–∫ 1: –û—à–∏–±–∫–∏ –≤ —Å–≤—è–∑—è—Ö –º–æ–¥–µ–ª–µ–π

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í–ª–∏—è–Ω–∏–µ:** –°—Ä–µ–¥–Ω–µ–µ

**–ú–µ—Ä—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ foreign keys
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ relationships
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏:**
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ foreign keys
- –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–∞—Å–∫–∞–¥–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
- –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–µ–π

---

### –†–∏—Å–∫ 2: –ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–í–ª–∏—è–Ω–∏–µ:** –ù–∏–∑–∫–æ–µ

**–ú–µ—Ä—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:**
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –≤ Pydantic
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –≤ SQLAlchemy
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ç–∏–ø–æ–≤

**–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–æ–≤
- –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Ç–∏–ø–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Any –¥–ª—è JSONB

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–æ–¥–µ–ª–∏:
   ```bash
   docker compose exec web python -c "from app.models.company import Company; print(Company)"
   ```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ö–µ–º—ã:
   ```bash
   docker compose exec web python -c "from app.schemas.company import CompanyResponse; print(CompanyResponse)"
   ```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ë–î:
   ```bash
   docker compose exec postgres psql -U barber_user -d barber_db -c "\dt public"
   ```

---

**–≠—Ç–∞–ø 2 –∑–∞–≤–µ—Ä—à–µ–Ω:** [ ]  
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** _________  
**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:** _________________


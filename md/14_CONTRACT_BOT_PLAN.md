## План: главный Telegram-бот — генерация договора

### Цели
- Бот доступен любому пользователю (без веб-админки).
- По кнопке “Генерация договора” пользователь вводит данные и получает ссылку на документ.
- Нумерация договора — автоматическая.
- Месяц в договоре — словами.
- Шаблон хранится на сервере в папке `dogovor/` как `dogovor-shablon-tg.docx`.

### Хранилище и структура
- Папка на сервере: `/opt/barber/dogovor/`
  - `dogovor-shablon-tg.docx` — шаблон.
  - `generated/` — сгенерированные договоры.
- Публичные ссылки на договоры:
  - Раздача через Nginx: `http://45.144.67.47/contracts/<uuid>.docx`

### Данные для шаблона
Плейсхолдеры в шаблоне (оставляем как есть):
- `{{НОМЕР_ДОГОВОРА}}`
- `{{ДЕНЬ}}`
- `{{МЕСЯЦ}}` — месяц словами.
- `{{ГОД}}`
- `{{НАЗВАНИЕ_ЗАКАЗЧИКА}}`
- `{{ИНН_ЗАКАЗЧИКА}}`
- `{{АДРЕС_ЗАКАЗЧИКА}}`
- `{{ОСНОВАНИЕ_ДЕЙСТВИЯ}}`
- `{{СРОК_ДЕЙСТВИЯ}}`
- `{{СТОИМОСТЬ_ЦИФРАМИ}}`
- `{{СТОИМОСТЬ_ПРОПИСЬЮ}}`
- `{{РЕКВИЗИТЫ_ЗАКАЗЧИКА}}`
- `{{БАНКОВСКИЕ_РЕКВИЗИТЫ_ЗАКАЗЧИКА}}` (опционально)
- `{{ФИО_ПОДПИСАНТА}}`

### Автонумерация
- Формат: `DOG-YYYYMMDD-XXXX` (XXXX — инкремент внутри дня).
- Источник: таблица `contract_requests` в public-схеме.

### Бот-сценарий (FSM)
1. `/start` → главное меню.
2. Кнопка “Генерация договора”.
3. Пошаговый сбор данных:
   - Название заказчика
   - ИНН/ОГРН
   - Адрес
   - Основание действия
   - Срок действия
   - Стоимость цифрами
   - Реквизиты заказчика
   - Банковские реквизиты (опционально)
   - ФИО подписанта
4. Подтверждение данных.
5. Генерация договора.
6. Отдача ссылки и файла в чат.

### Генерация документа
- Инструменты: `docxtpl` + `num2words` (русский).
- Месяц словами: `января`, `февраля`, … (родительный падеж).
- `СТОИМОСТЬ_ПРОПИСЬЮ` формируется автоматически из цифр.

### Backend-сущность (public)
Таблица `contract_requests`:
- `id` (PK)
- `status` (`new|collecting|generated|failed`)
- `requester_telegram_id`
- `data` (JSONB)
- `contract_number`
- `document_path`
- `public_url`
- `created_at`, `updated_at`

### Безопасность
- Токен бота хранится только в `.env`/секретах.
- Логирование без токена и персональных данных.

### Деплой
- Добавить папку `dogovor/` и `generated/`.
- Настроить Nginx на раздачу `/contracts/`.
- Пересборка контейнера `bot`.

### Проверки готовности
- Пользователь без прав может сгенерировать договор.
- Ссылка открывается и отдает файл.
- Автонумерация не конфликтует.
- Месяц в документе — словами.

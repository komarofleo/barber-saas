# –≠—Ç–∞–ø 3: Backend - –ú—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç—å

**–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 3-4 –¥–Ω—è  
**–°—Ç–∞—Ç—É—Å:** ‚è≥ –í –æ–∂–∏–¥–∞–Ω–∏–∏  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–¶–µ–ª—å —ç—Ç–∞–ø–∞](#—Ü–µ–ª—å-—ç—Ç–∞–ø–∞)
2. [–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è](#–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
3. [–ü–æ–¥–∑–∞–¥–∞—á–∏](#–ø–æ–¥–∑–∞–¥–∞—á–∏)
4. [–ß–µ–∫-–ª–∏—Å—Ç —ç—Ç–∞–ø–∞](#—á–µ–∫-–ª–∏—Å—Ç-—ç—Ç–∞–ø–∞)
5. [–†–∏—Å–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ](#—Ä–∏—Å–∫–∏-–∏-–∏—Ö-—Ä–µ—à–µ–Ω–∏–µ)

---

## üéØ –¶–µ–ª—å —ç—Ç–∞–ø–∞

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å—Ö–µ–º–∞–º–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –º—É–ª—å—Ç–∏-—Ç–µ–Ω–∞–Ω—Ç–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

- SessionManager –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å—Ö–µ–º–∞–º–∏
- Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏
- CRUD —Ñ—É–Ω–∫—Ü–∏–∏ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º company_id
- –§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è —Å—Ö–µ–º
- –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ö–µ–º

---

## üîß –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã

- [ ] –≠—Ç–∞–ø 2 –∑–∞–≤–µ—Ä—à–µ–Ω (–º–æ–¥–µ–ª–∏ –∏ —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã)
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏–∑ —ç—Ç–∞–ø–∞ 1 –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- [ ] –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ö–µ–º–∞–º–∏ –≤ PostgreSQL

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.11+ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- PostgreSQL 15+
- SQLAlchemy 2.0 (async)
- –ü–æ–Ω–∏–º–∞–Ω–∏–µ PostgreSQL Schemas

---

## üìù –ü–æ–¥–∑–∞–¥–∞—á–∏

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 3.1: –û–±–Ω–æ–≤–∏—Ç—å database.py –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å—Ö–µ–º–∞–º–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥—É–ª—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ö–µ–º.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/database.py
   ```

2. –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã:
   ```python
   from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker
   from sqlalchemy import text
   from sqlalchemy.orm import declarative_base
   ```

3. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–∏ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å—Ö–µ–º—ã:
   ```python
   async def get_session_with_schema(schema_name: str = "public"):
       """–ü–æ–ª—É—á–∏—Ç—å —Å–µ—Å—Å–∏—é —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å—Ö–µ–º—ã"""
       async with engine.connect() as conn:
           await conn.execute(
               text(f"SET search_path TO {schema_name}, public")
           )
           await conn.commit()
       
       return AsyncSessionLocal()
   ```

4. –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é get_session –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ö–µ–º—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
   ```python
   async def get_session():
       """–ü–æ–ª—É—á–∏—Ç—å —Å–µ—Å—Å–∏—é (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ö–µ–º—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"""
       return AsyncSessionLocal()
   ```

5. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π —Å—Ö–µ–º—ã:
   ```python
   async def create_tenant_schema(company_id: int):
       """–°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞"""
       schema_name = f"tenant_{company_id}"
       
       async with engine.begin() as conn:
           await conn.execute(
               text(f"CREATE SCHEMA IF NOT EXISTS {schema_name}")
           )
   
       return schema_name
   ```

6. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ö–µ–º—ã:
   ```python
   async def drop_tenant_schema(company_id: int):
       """–£–¥–∞–ª–∏—Ç—å —Å—Ö–µ–º—É –∫–ª–∏–µ–Ω—Ç–∞"""
       schema_name = f"tenant_{company_id}"
       
       async with engine.begin() as conn:
           await conn.execute(
               text(f"DROP SCHEMA IF EXISTS {schema_name} CASCADE")
           )
   
       return schema_name
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã
- [ ] get_session_with_schema —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] create_tenant_schema —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] drop_tenant_schema —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 3.2: –°–æ–∑–¥–∞—Ç—å TenantService –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º–∞–º–∏

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º–∞–º–∏ –∏ –º–∏–≥—Ä–∞—Ü–∏—è–º–∏.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/services/tenant_service.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–ª–∞—Å—Å –∏ –º–µ—Ç–æ–¥—ã:
   ```python
   from sqlalchemy import text
   from sqlalchemy.ext.asyncio import AsyncSession
   from typing import List
   import subprocess
   import asyncio
   from app.database import engine
   
   class TenantService:
       """–°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ö–µ–º–∞–º–∏"""
       
       @staticmethod
       async def create_tenant_schema(company_id: int):
           """–°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞"""
           schema_name = f"tenant_{company_id}"
           
           async with engine.begin() as conn:
               await conn.execute(
                   text(f"CREATE SCHEMA IF NOT EXISTS {schema_name}")
               )
           
           return schema_name
       
       @staticmethod
       async def drop_tenant_schema(company_id: int):
           """–£–¥–∞–ª–∏—Ç—å —Å—Ö–µ–º—É –∫–ª–∏–µ–Ω—Ç–∞"""
           schema_name = f"tenant_{company_id}"
           
           async with engine.begin() as conn:
               await conn.execute(
                   text(f"DROP SCHEMA IF EXISTS {schema_name} CASCADE")
               )
       
       @staticmethod
       async def apply_migrations_to_schema(company_id: int):
           """–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ —Å—Ö–µ–º–µ –∫–ª–∏–µ–Ω—Ç–∞"""
           schema_name = f"tenant_{company_id}"
           
           # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º search_path –Ω–∞ —Å—Ö–µ–º—É
           async with engine.begin() as conn:
               await conn.execute(
                   text(f"SET search_path TO {schema_name}, public")
               )
           
           # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ alembic
           # –í–∞–∂–Ω–æ: alembic –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ö–µ–º—É
           cmd = [
               "alembic",
               "upgrade",
               "head",
               f"--sql"
           ]
           
           # –î–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ö–µ–º–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
           env = {"ALEMBIC_SCHEMA": schema_name}
           
           result = await asyncio.create_subprocess_exec(
               cmd,
               env=env,
               stdout=asyncio.subprocess.PIPE,
               stderr=asyncio.subprocess.PIPE
           )
           
           stdout, stderr = await result.communicate()
           
           if result.returncode != 0:
               raise Exception(f"–û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: {stderr.decode()}")
           
           return True
       
       @staticmethod
       async def copy_schema_structure(source_schema: str, target_schema: str):
           """–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ö–µ–º—ã"""
           # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü –∏—Å—Ö–æ–¥–Ω–æ–π —Å—Ö–µ–º—ã
           async with engine.begin() as conn:
               result = await conn.execute(
                   text(f"""
                       SELECT table_name 
                       FROM information_schema.tables 
                       WHERE table_schema = '{source_schema}'
                       AND table_type = 'BASE TABLE'
                   """)
               )
               tables = [row[0] for row in result]
               
               for table in tables:
                   # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ —Ü–µ–ª–µ–≤–æ–π —Å—Ö–µ–º–µ
                   await conn.execute(
                       text(f"CREATE TABLE {target_schema}.{table} AS SELECT * FROM {source_schema}.{table}")
                   )
               
               await conn.commit()
           
           return tables
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] TenantService —Å–æ–∑–¥–∞–Ω
- [ ] create_tenant_schema —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] drop_tenant_schema —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] apply_migrations_to_schema —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] copy_schema_structure —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 3.3: –°–æ–∑–¥–∞—Ç—å subscription_middleware

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–ø–∏—Å–∏.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/middleware/subscription_middleware.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å middleware:
   ```python
   from fastapi import Request, HTTPException
   from starlette.middleware.base import BaseHTTPMiddleware
   from sqlalchemy.ext.asyncio import AsyncSession
   from sqlalchemy import select
   
   from app.database import get_session_with_schema
   from app.models.company import Company
   
   class SubscriptionMiddleware(BaseHTTPMiddleware):
       """Middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏"""
       
       async def dispatch(self, request: Request, call_next):
           """–ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –∑–∞–ø–∏—Å–∏"""
           
           # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è endpoints —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π
           if "/bookings" in request.url.path and request.method == "POST":
               # –ü–æ–ª—É—á–∞–µ–º company_id –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
               company_id = self._get_company_id(request)
               
               if company_id:
                   # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
                   async for session in get_session_with_schema("public"):
                       result = await session.execute(
                           select(Company).where(Company.id == company_id)
                       )
                       company = result.scalar_one_or_none()
                       
                       if not company or not company.can_create_bookings:
                           raise HTTPException(
                               status_code=402,
                               detail={
                                   "error": "subscription_expired",
                                   "message": "–ó–∞–ø–∏—Å—å –æ—Ç–∫–ª—é—á–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.",
                                   "can_view": True  # –ú–æ–∂–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ
                               }
                           )
           
           response = await call_next(request)
           return response
       
       def _get_company_id(self, request: Request) -> int:
           """–ü–æ–ª—É—á–∏—Ç—å company_id –∏–∑ –∑–∞–ø—Ä–æ—Å–∞"""
           # –ò–∑ JWT —Ç–æ–∫–µ–Ω–∞
           if hasattr(request.state, "user"):
               user = request.state.user
               return getattr(user, "company_id", None)
           
           # –ò–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
           return request.query_params.get("company_id")
   
   async def check_subscription(company_id: int):
       """–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∫–æ–º–ø–∞–Ω–∏–∏"""
       async for session in get_session_with_schema("public"):
           result = await session.execute(
               select(Company).where(Company.id == company_id)
           )
           company = result.scalar_one_or_none()
           
           if not company:
               raise HTTPException(
                   status_code=404,
                   detail="–ö–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
               )
           
           if not company.can_create_bookings:
               raise HTTPException(
                   status_code=402,
                   detail={
                       "error": "subscription_expired",
                       "message": "–ó–∞–ø–∏—Å—å –æ—Ç–∫–ª—é—á–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–¥–ª–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É."
                   }
               )
           
           return company
   ```

3. –î–æ–±–∞–≤–∏—Ç—å middleware –≤ main.py:
   ```python
   from app.middleware.subscription_middleware import SubscriptionMiddleware
   
   app.add_middleware(SubscriptionMiddleware)
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] Middleware —Å–æ–∑–¥–∞–Ω
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Middleware –¥–æ–±–∞–≤–ª–µ–Ω –≤ main.py
- [ ] –û—à–∏–±–∫–∞ 402 –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –ú–æ–∂–Ω–æ —Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∏—Å—Ç–µ–∫—à–µ–π –ø–æ–¥–ø–∏—Å–∫–µ

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 3.4: –°–æ–∑–¥–∞—Ç—å company_middleware

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å middleware –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/middleware/company_middleware.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å middleware:
   ```python
   from fastapi import Request
   from starlette.middleware.base import BaseHTTPMiddleware
   
   class CompanyMiddleware(BaseHTTPMiddleware):
       """Middleware –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏"""
       
       async def dispatch(self, request: Request, call_next):
           """–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏ –≤ request.state"""
           
           # –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å company_id
           company_id = self._get_company_id(request)
           
           if company_id:
               request.state.company_id = company_id
               request.state.schema_name = f"tenant_{company_id}"
           
           response = await call_next(request)
           return response
       
       def _get_company_id(self, request: Request) -> int:
           """–ü–æ–ª—É—á–∏—Ç—å company_id –∏–∑ –∑–∞–ø—Ä–æ—Å–∞"""
           # –ò–∑ JWT —Ç–æ–∫–µ–Ω–∞ (–µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
           if hasattr(request.state, "user"):
               user = request.state.user
               return getattr(user, "company_id", None)
           
           # –ò–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞
           company_id = request.query_params.get("company_id")
           if company_id:
               try:
                   return int(company_id)
               except ValueError:
                   pass
           
           # –ò–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞
           company_id = request.headers.get("X-Company-ID")
           if company_id:
               try:
                   return int(company_id)
               except ValueError:
                   pass
           
           return None
   ```

3. –î–æ–±–∞–≤–∏—Ç—å middleware –≤ main.py:
   ```python
   from app.middleware.company_middleware import CompanyMiddleware
   
   app.add_middleware(CompanyMiddleware)
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] Middleware —Å–æ–∑–¥–∞–Ω
- [ ] company_id –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] schema_name –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] Middleware –¥–æ–±–∞–≤–ª–µ–Ω –≤ main.py
- [ ] request.state –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 3.5: –û–±–Ω–æ–≤–∏—Ç—å CRUD —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å company_id

**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ CRUD —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ö–µ–º–æ–π.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –û–±–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/api/bookings.py
   ```

2. –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é get_bookings:
   ```python
   @router.get("", response_model=BookingListResponse)
   async def get_bookings(
       page: int = Query(1, ge=1),
       page_size: int = Query(20, ge=1, le=1000),
       status: Optional[str] = None,
       start_date: Optional[date] = None,
       end_date: Optional[date] = None,
       master_id: Optional[int] = None,
       service_id: Optional[int] = None,
       post_id: Optional[int] = None,
       search: Optional[str] = None,
       company_id: int = Query(..., description="ID –∫–æ–º–ø–∞–Ω–∏–∏"),
       db: AsyncSession = Depends(get_db),
       current_user: User = Depends(get_current_user),
   ):
       """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø–∏—Å–µ–π"""
       # –ò—Å–ø–æ–ª—å–∑—É–µ–º company_id –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ö–µ–º—ã
       async for session in get_session_with_schema(f"tenant_{company_id}"):
           # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
           pass
   ```

3. –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é create_booking:
   ```python
   @router.post("", response_model=BookingResponse, status_code=201)
   async def create_booking(
       booking_data: BookingCreateRequest,
       company_id: int = Query(..., description="ID –∫–æ–º–ø–∞–Ω–∏–∏"),
       db: AsyncSession = Depends(get_db),
       current_user: User = Depends(get_current_user),
   ):
       """–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞–ø–∏—Å—å"""
       # –ò—Å–ø–æ–ª—å–∑—É–µ–º company_id –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ö–µ–º—ã
       async for session in get_session_with_schema(f"tenant_{company_id}"):
           # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (—á–µ—Ä–µ–∑ middleware —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ)
           # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
           pass
   ```

4. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ CRUD —Ñ—É–Ω–∫—Ü–∏–∏:
   - users.py
   - services.py
   - masters.py
   - posts.py
   - clients.py
   - blocks.py
   - promocodes.py
   - promotions.py
   - broadcasts.py

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] bookings.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] users.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] services.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] masters.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] posts.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] clients.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] –í—Å–µ API —Ä–∞–±–æ—Ç–∞—é—Ç —Å company_id

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 3.6: –û–±–Ω–æ–≤–∏—Ç—å auth –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å company_id

**–û–ø–∏—Å–∞–Ω–∏–µ:** –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥—É–ª—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å—Ö–µ–º–∞–º–∏.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/api/auth.py
   ```

2. –û–±–Ω–æ–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é login:
   ```python
   @router.post("/login")
   async def login(
       credentials: AuthLogin,
       company_id: int = Query(..., description="ID –∫–æ–º–ø–∞–Ω–∏–∏"),
       db: AsyncSession = Depends(get_db),
   ):
       """–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è"""
       # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏
       async for public_session in get_session_with_schema("public"):
           from app.models.company import Company
           result = await public_session.execute(
               select(Company).where(Company.id == company_id)
           )
           company = result.scalar_one_or_none()
           
           if not company:
               raise HTTPException(status_code=404, detail="–ö–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
           
           # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏
           if not company.is_active:
               raise HTTPException(
                   status_code=403,
                   detail="–ö–æ–º–ø–∞–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞"
               )
       
       # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å—Ö–µ–º–µ –∫–ª–∏–µ–Ω—Ç–∞
       async for session in get_session_with_schema(f"tenant_{company_id}"):
           # ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
           pass
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] auth.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å company_id

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 3.7: –°–æ–∑–¥–∞—Ç—å Alembic —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è tenant-—Å—Ö–µ–º

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å Alembic —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π –∫ tenant-—Å—Ö–µ–º–∞–º.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã tenant-—Å—Ö–µ–º—ã:
   ```
   scripts/create_tenant_schema.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ª–æ–≥–∏–∫—É:
   ```python
   import sys
   import asyncio
   from sqlalchemy import text
   
   from app.database import engine
   
   async def create_tenant_schema(company_id: int):
       """–°–æ–∑–¥–∞—Ç—å tenant-—Å—Ö–µ–º—É –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏"""
       schema_name = f"tenant_{company_id}"
       
       async with engine.begin() as conn:
           # –°–æ–∑–¥–∞–µ–º —Å—Ö–µ–º—É
           await conn.execute(
               text(f"CREATE SCHEMA IF NOT EXISTS {schema_name}")
           )
           
           # –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –∫ —ç—Ç–æ–π —Å—Ö–µ–º–µ
           # –í–∞–∂–Ω–æ: –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å alembic programmatically
           print(f"‚úÖ –°—Ö–µ–º–∞ {schema_name} —Å–æ–∑–¥–∞–Ω–∞")
       
       return schema_name
   
   if __name__ == "__main__":
       if len(sys.argv) < 2:
           print("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: python create_tenant_schema.py <company_id>")
           sys.exit(1)
       
       company_id = int(sys.argv[1])
       asyncio.run(create_tenant_schema(company_id))
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω
- [ ] –°—Ö–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è
- [ ] –°–∫—Ä–∏–ø—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 3.8: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–ª—è—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —Ä–∞–∑–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:
   ```
   scripts/test_data_isolation.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–µ—Å—Ç—ã:
   ```python
   import asyncio
   from sqlalchemy import text, select
   from sqlalchemy.ext.asyncio import AsyncSession
   
   from app.database import get_session_with_schema, engine
   from app.models.booking import Booking
   from app.models.client import Client
   
   async def test_data_isolation():
       """–¢–µ—Å—Ç –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö"""
       
       # –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ–¥–Ω–æ–π —Å—Ö–µ–º—ã –Ω–µ –≤–∏–¥–Ω—ã –≤ –¥—Ä—É–≥–æ–π
       async for session_1 in get_session_with_schema("tenant_001"):
           # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞–ø–∏—Å—å
           await session_1.execute(
               text("INSERT INTO bookings (booking_number, client_id, date, time, duration, end_time, status) VALUES ('TEST_001', 1, CURRENT_DATE, '09:00', 30, '09:30', 'new')")
           )
           await session_1.commit()
           
           # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø–∏—Å—å –≤–∏–¥–Ω–∞
           result = await session_1.execute(
               select(Booking).where(Booking.booking_number == 'TEST_001')
           )
           booking = result.scalar_one_or_none()
           print(f"‚úÖ –ó–∞–ø–∏—Å—å –≤–∏–¥–Ω–∞ –≤ tenant_001: {booking is not None}")
       
       # –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø–∏—Å—å –ù–ï –≤–∏–¥–Ω–∞ –≤ –¥—Ä—É–≥–æ–π —Å—Ö–µ–º–µ
       async for session_2 in get_session_with_schema("tenant_002"):
           result = await session_2.execute(
               select(Booking).where(Booking.booking_number == 'TEST_001')
           )
           booking = result.scalar_one_or_none()
           print(f"‚úÖ –ó–∞–ø–∏—Å—å –ù–ï –≤–∏–¥–Ω–∞ –≤ tenant_002: {booking is None}")
       
       # –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü –≤ —Ä–∞–∑–Ω—ã—Ö —Å—Ö–µ–º–∞—Ö
       async with engine.begin() as conn:
           # –¢–∞–±–ª–∏—Ü—ã –≤ tenant_001
           result = await conn.execute(
               text("""
                   SELECT COUNT(*) 
                   FROM information_schema.tables 
                   WHERE table_schema = 'tenant_001'
               """)
           )
           count_001 = result.scalar()
           
           # –¢–∞–±–ª–∏—Ü—ã –≤ tenant_002
           result = await conn.execute(
               text("""
                   SELECT COUNT(*) 
                   FROM information_schema.tables 
                   WHERE table_schema = 'tenant_002'
               """)
           )
           count_002 = result.scalar()
           
           print(f"‚úÖ tenant_001 —Ç–∞–±–ª–∏—Ü: {count_001}")
           print(f"‚úÖ tenant_002 —Ç–∞–±–ª–∏—Ü: {count_002}")
           
           assert count_001 > 0, "tenant_001 –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Ç–∞–±–ª–∏—Ü—ã"
           # tenant_002 –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π
   
       print("‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –∏–∑–æ–ª—è—Ü–∏–∏ –ø—Ä–æ–π–¥–µ–Ω—ã!")
   
   if __name__ == "__main__":
       asyncio.run(test_data_isolation())
   ```

3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã:
   ```bash
   docker compose exec web python scripts/test_data_isolation.py
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –°–∫—Ä–∏–ø—Ç —Ç–µ—Å—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω
- [ ] –¢–µ—Å—Ç –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–π–¥–µ–Ω
- [ ] –¢–µ—Å—Ç –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω
- [ ] –¢–µ—Å—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∞–±–ª–∏—Ü –ø—Ä–æ–π–¥–µ–Ω
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã —É—Å–ø–µ—à–Ω—ã

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç —ç—Ç–∞–ø–∞

### SessionManager –∏ Database

- [ ] database.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] get_session_with_schema —Å–æ–∑–¥–∞–Ω–∞
- [ ] create_tenant_schema —Å–æ–∑–¥–∞–Ω–∞
- [ ] drop_tenant_schema —Å–æ–∑–¥–∞–Ω–∞
- [ ] –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### TenantService

- [ ] TenantService —Å–æ–∑–¥–∞–Ω
- [ ] create_tenant_schema —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] drop_tenant_schema —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] apply_migrations_to_schema —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] copy_schema_structure —Ä–∞–±–æ—Ç–∞–µ—Ç

### Middleware

- [ ] subscription_middleware —Å–æ–∑–¥–∞–Ω
- [ ] company_middleware —Å–æ–∑–¥–∞–Ω
- [ ] Middleware –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ main.py
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ company_id —Ä–∞–±–æ—Ç–∞–µ—Ç

### CRUD —Ñ—É–Ω–∫—Ü–∏–∏

- [ ] bookings.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] users.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] services.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] masters.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] posts.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] clients.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] –í—Å–µ API —Ä–∞–±–æ—Ç–∞—é—Ç —Å company_id

### Auth

- [ ] auth.py –æ–±–Ω–æ–≤–ª–µ–Ω
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∞–Ω–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ú–∏–≥—Ä–∞—Ü–∏–∏

- [ ] –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω
- [ ] –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ö–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] –¢–µ—Å—Ç—ã –∏–∑–æ–ª—è—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã
- [ ] –¢–µ—Å—Ç –∏–∑–æ–ª—è—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–π–¥–µ–Ω
- [ ] –¢–µ—Å—Ç –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω
- [ ] –ù–µ—Ç —É—Ç–µ—á–µ–∫ –¥–∞–Ω–Ω—ã—Ö

---

## ‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ

### –†–∏—Å–∫ 1: –£—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —Å—Ö–µ–º–∞–º–∏

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–í–ª–∏—è–Ω–∏–µ:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ

**–ú–µ—Ä—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:**
- –°—Ç—Ä–æ–≥–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ search_path
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–ª—è—Ü–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ middleware

**–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏:**
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤ middleware
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ schema.table_name
- –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–ª—è—Ü–∏–∏

---

### –†–∏—Å–∫ 2: –û—à–∏–±–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å—Ö–µ–º

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í–ª–∏—è–Ω–∏–µ:** –°—Ä–µ–¥–Ω–µ–µ

**–ú–µ—Ä—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:**
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–π
- –í–∞–ª–∏–¥–∞—Ü–∏—è schema_name

**–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏:**
- –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –û—Ç–∫–∞—Ç –∫ default —Å—Ö–µ–º–µ
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

---

### –†–∏—Å–∫ 3: –ü—Ä–æ–±–ª–µ–º—ã —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ –≤ tenant-—Å—Ö–µ–º–∞—Ö

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í–ª–∏—è–Ω–∏–µ:** –í—ã—Å–æ–∫–æ–µ

**–ú–µ—Ä—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:**
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ

**–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏:**
- –†—É—á–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π
- –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã
- –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –±—ç–∫–∞–ø–∞

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ö–µ–º—ã:
   ```bash
   docker compose exec postgres psql -U barber_user -d barber_db -c "\dn"
   ```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤ —Å—Ö–µ–º–µ:
   ```bash
   docker compose exec postgres psql -U barber_user -d barber_db -c "\dt tenant_001"
   ```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å search_path:
   ```bash
   docker compose exec postgres psql -U barber_user -d barber_db -c "SHOW search_path;"
   ```

4. –°–±—Ä–æ—Å–∏—Ç—å search_path:
   ```bash
   docker compose exec postgres psql -U barber_user -d barber_db -c "SET search_path TO public;"
   ```

---

**–≠—Ç–∞–ø 3 –∑–∞–≤–µ—Ä—à–µ–Ω:** [ ]  
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** _________  
**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:** _________________


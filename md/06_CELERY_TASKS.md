# Этап 6: Celery задачи

**Продолжительность:** 3-4 дня  
**Статус:** ⏳ В ожидании  
**Приоритет:** Критический  

---

## 🎯 Цель

Создать полноценную систему асинхронных задач и периодических напоминаний для мульти-тенантной SaaS платформы Barber.

---

## 📦 Требования

### 1. Функционал

#### ✅ Напоминания о подписках
- Напоминание за 7 дней до окончания подписки
- Напоминание за 3 дня до окончания подписки
- Напоминание за 1 день до окончания подписки
- Напоминание об окончании подписки
- Напоминание о неоплате (каждые 3 дня после окончания)

#### ✅ Webhook обработка от Юкассы
- Обработка успешного платежа → активация подписки
- Обработка неуспешной оплаты → отмена подписки
- Обработка отмены платежа

#### ✅ Периодические задачи
- Ежедневная проверка подписок
- Ежедневные напоминания об окончании/неоплате
- Обновление статуса подписок

### 2. Компоненты

#### Celery Worker (новый)
- ✅ `web/backend/app/tasks/subscription_notifications.py`
  - `send_reminder_7_days_before()` - напоминание за 7 дней
  - `send_reminder_3_days_before()` - напоминание за 3 дня
  - `send_reminder_1_day_before()` - напоминание за 1 день
  - `send_reminder_expiration()` - напоминание об окончании
  - `send_payment_reminder()` - напоминание о неоплате

#### Celery Beat (настройка)
- ✅ `web/backend/celeryconfig.py`
  - Настройка расписания Celery Beat
  - Ежедневные задачи (cron schedule)
  - Задачи для проверки подписок

#### Docker Compose (обновление)
- ✅ `docker-compose.yml`
  - Добавление Celery Worker
  - Добавление Celery Beat
  - Настройка переменных окружения для Redis

### 3. Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                  Celery Architecture          │
│                                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │      Celery Beat (Scheduler)             │   │
│  │    (Периодические задачи)               │   │
│  └─────────────────────────────────────────────────────┘   │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │        Celery Worker                      │   │
│  │    (Асинхронные задачи)                  │   │
│  │                                             │   │
│  │    - subscription_notifications.py      │   │
│  │    - send_reminder_7_days_before()    │   │
│  │    - send_reminder_3_days_before()    │   │
│  │    - send_reminder_1_day_before()    │   │
│  │    - send_reminder_expiration()         │   │
│  │    - send_payment_reminder()            │   │
│  │                                             │   │
│  │    - Очереди (Redis broker)            │   │
│  │    - Worker processes                    │   │
│  │                                             │   │
│  └─────────────────────────────────────────────────────┘   │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │         Backend API                      │   │
│  │    (Webhook обработка)                   │   │
│  │                                             │   │
│  │    - POST /api/public/webhooks/yookassa│   │
│  │    - payment.succeeded → активация      │   │
│  │    - payment.canceled → отмена       │   │
│  └─────────────────────────────────────────────────────┘   │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │         Telegram Bot                      │   │
│  │    (Отправка уведомлений)              │   │
│  │                                             │   │
│  │    - Отправка напоминаний через Bot API  │   │
│  │    - Использование токена бота компании  │   │
│  │                                             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                           │
└─────────────────────────────────────────────────────────────────┘
```

**Механизм работы:**
1. **Celery Beat:** Ежедневно в 00:00 запускает задачи для проверки подписок
2. **Проверка подписок:** Для каждой активной компании проверяется дата окончания подписки
3. **Напоминания:**
   - За 7 дней → первая напоминание
   - За 3 дня → вторая напоминание
   - За 1 день → последняя напоминание
   - В день окончания → напоминание об окончании
4. **Неуплата:** После окончания подписки → каждые 3 дня напоминание о неоплате
5. **Webhook:** При успешной оплате → активация подписки

---

## 🚀 Реализация

### Шаг 6.1: Создать Celery задачи для напоминаний

**Задачи:**
- [ ] Создать `web/backend/app/tasks/subscription_notifications.py`
- [ ] `send_reminder_7_days_before()` - напоминание за 7 дней
- [ ] `send_reminder_3_days_before()` - напоминание за 3 дня
- [ ] `send_reminder_1_day_before()` - напоминание за 1 день
- [ ] `send_reminder_expiration()` - напоминание об окончании
- [ ] `send_payment_reminder()` - напоминание о неоплате

**Требования:**
- Использовать `@shared_task` для Celery задач
- Работать с `public` схемой (Company, Subscription, Payment)
- Получать список компаний с истекающими подписками
- Отправлять уведомления через Telegram Bot API
- Логировать все операции

### Шаг 6.2: Настроить Celery Beat

**Задачи:**
- [ ] Создать `web/backend/celeryconfig.py`
- [ ] Настроить расписание для периодических задач
- [ ] `celery beat_schedule` для ежедневных проверок подписок
- [ ] `check_subscriptions()` - ежедневная проверка подписок
- [ ] `send_expired_subscriptions_reminders()` - отправка напоминаний

**Требования:**
- Использовать `crontab` для планирования задач (ежедневно)
- Получать список компаний с активными подписками
- Проверять даты окончания подписок
- Отправлять напоминания о приближающемся окончании

### Шаг 6.3: Добавить Celery Worker в Docker Compose

**Задачи:**
- [ ] Обновить `docker-compose.yml`
- [ ] Добавить сервис `celery-worker`
- [ ] Настроить команды для запуска worker
- [ ] Добавить переменные окружения для Redis

**Требования:**
- Отдельный сервис для Celery Worker
- Настройка `CELERY_BROKER_URL=redis://redis:6379`
- Количество worker processes
- Настройка логирования

### Шаг 6.4: Протестировать Celery задачи

**Задачи:**
- [ ] Протестировать `send_reminder_7_days_before()`
- [ ] Протестировать `send_reminder_3_days_before()`
- [ ] Протестировать `send_reminder_1_day_before()`
- [ ] Протестировать `send_reminder_expiration()`
- [ ] Протестировать `send_payment_reminder()`
- [ ] Протестировать Celery Beat
- [ ] Проверить работу с Redis
- [ ] Проверить отправку уведомлений через Telegram Bot API

**Требования:**
- Проверять логи Celery Worker
- Проверять логи Celery Beat
- Проверять отправку уведомлений
- Убедиться в корректности работы

---

## 📝 Чек-лист завершения

### Шаг 6.1: Создать Celery задачи для напоминаний
- [ ] Создать `web/backend/app/tasks/subscription_notifications.py`
- [ ] `send_reminder_7_days_before()`
- [ ] `send_reminder_3_days_before()`
- [ ] `send_reminder_1_day_before()`
- [ ] `send_reminder_expiration()`
- [ ] `send_payment_reminder()`

### Шаг 6.2: Настроить Celery Beat
- [ ] Создать `web/backend/celeryconfig.py`
- [ ] Настроить `celery beat_schedule`
- [ ] `check_subscriptions()`
- [ ] `send_expired_subscriptions_reminders()`

### Шаг 6.3: Добавить Celery Worker в Docker Compose
- [ ] Обновить `docker-compose.yml`
- [ ] Добавить сервис `celery-worker`
- [ ] Настроить переменные окружения для Redis

### Шаг 6.4: Протестировать Celery задачи
- [ ] Протестировать все задачи
- [ ] Проверить работу с Redis
- [ ] Проверить отправку уведомлений

---

## 📊 План работ

### День 1
- Утро: Создание Celery задач
- День: Настройка Celery Beat
- Вечер: Интеграция с Docker Compose

### День 2
- Утро: Протестирование Celery задач
- День: Протестирование Celery Beat
- Вечер: Тестирование отправки уведомлений

---

## 🎯 Ожидаемые результаты

- Полноценная система асинхронных задач через Celery
- Периодические напоминания о подписках
- Автоматическая проверка статуса подписок
- Webhook обработка от Юкассы
- Интеграция с Redis для очередей задач
- Настройка Celery Beat для планирования

---

**Примечание:** Celery задачи критически важны для бизнес-модели SaaS платформы. Без них система не будет автоматически напоминать о подписках.

# Этап 10: Frontend админ-панель компании

**Продолжительность:** 2-3 дня  
**Статус:** ⏳ В ожидании  
**Приоритет:** Средний  

---

## 🎯 Цель

Адаптировать существующую админ-панель для работы с мульти-тенантной архитектурой.

---

## 📦 Требования

### 1. Функционал

#### ✅ Обновление API клиентов для работы с tenant схемами
- Передача `company_id` во все запросы к API
- Обновление сессий для работы с tenant схемами
- Изоляция данных между компаниями

#### ✅ Обновление хендлеров Dashboard для работы с tenant схемами
- Статистика только для текущей компании
- Графики доходов только для текущей компании
- Список записей только для текущей компании

#### ✅ Адаптация всех CRUD операций
- Работа с `company_id` в headers
- Проверка подписки перед операциями
- Блокировка при истекшей подписке

### 2. Компоненты

#### Адаптируемые существующие компоненты
- ✅ `web/frontend/src/pages/Dashboard.tsx` - Дэшборд компании
- ✅ `web/frontend/src/pages/Billing.tsx` - Страница биллинга
- ✅ `web/frontend/src/pages/Services.tsx` - Страница услуг
- ✅ `web/frontend/src/pages/Masters.tsx` - Страница мастеров
- ✅ `web/frontend/src/pages/Bookings.tsx` - Страница записей
- ✅ `web/frontend/src/pages/Clients.tsx` - Страница клиентов
- ✅ `web/frontend/src/pages/Posts.tsx` - Страница постов
- ✅ `web/frontend/src/pages/Broadcasts.tsx` - Страница рассылок
- ✅ `web/frontend/src/pages/Promocodes.tsx` - Страница промокодов
- ✅ `web/frontend/src/pages/Promotions.tsx` - Страница акций
- ✅ `web/frontend/src/pages/Settings.tsx` - Страница настроек
- ✅ `web/frontend/src/pages/Data.tsx` - Страница данных

#### API клиенты
- ✅ `web/frontend/src/api/client.ts` - API клиент для всех запросов
- ✅ `web/frontend/src/api/bookings.ts` - API для записей
- ✅ `web/frontend/src/api/services.ts` - API для услуг
- ✅ `web/frontend/src/api/masters.ts` - API для мастеров
- ✅ `web/frontend/src/api/clients.ts` - API для клиентов
- ✅ `web/frontend/src/api/posts.ts` - API для постов
- ✅ `web/frontend/src/api/broadcasts.ts` - API для рассылок
- ✅ `web/frontend/src/api/promocodes.ts` - API для промокодов
- ✅ `web/frontend/src/api/promotions.ts` - API для акций
- ✅ `web/frontend/src/api/settings.ts` - API для настроек

### 3. Архитектура

```
┌─────────────────────────────────────────────────────────┐
│        Frontend Company Admin Architecture       │
│                                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │         Company Admin Panel (tenant)     │   │
│  │    (Адаптированная админ-панель)             │   │
│  └─────────────────────────────────────────────────────┘   │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │         API Clients (with company_id)   │   │
│  │    (Обновленный для работы с tenant)      │   │
│  │                                                      │   │
│  │    - bookings.ts                               │   │
│  │    - services.ts                               │   │
│  │    - masters.ts                                │   │
│  │    - clients.ts                                │   │
│  │    - posts.ts                                  │   │
│  │    - etc.                                    │   │
│  │                                                      │   │
│  │    - Передача company_id в headers         │   │
│  │    - Работа с tenant сессиями                 │   │
│  └─────────────────────────────────────────────────────┘   │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │         Backend API (tenant)               │   │
│  │    (CRUD endpoints с company_id)           │   │
│  │                                                      │   │
│  │    - /api/bookings                              │   │
│  │    - /api/services                                │   │
│  │    - /api/masters                                 │   │
│  │    - /api/clients                                  │   │
│  │    - /api/posts                                    │   │
│  │    - etc.                                     │   │
│  │                                                      │   │
│  │    - Проверка company_id в headers          │   │
│  │    - Работа с tenant схемой                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                           │
└─────────────────────────────────────────────────────────────────┘
```

**Механизм работы:**
1. **Вход:** Пользователь заходит через `/login` → токен сохраняется
2. **Выбор компании:** Супер-админ выбирает компанию → `company_id` сохраняется
3. **Headers:** Все запросы к API добавляют `X-Company-ID` header
4. **Backend:** Backend проверяет `company_id` и работает с tenant схемой
5. **Dashboard:** Админ-панель загружает данные только для текущей компании
6. **Статистика:** Все данные (статистика, графики, списки) только для текущей компании
7. **Безопасность:** Изоляция данных между компаниями

---

## 🚀 Реализация

### Шаг 10.1: Обновить API клиентов для работы с tenant схемами

**Задачи:**
- [ ] Обновить `web/frontend/src/api/client.ts` для добавления `company_id` в headers
- [ ] Обновить `web/frontend/src/api/bookings.ts` для работы с tenant схемами
- [ ] Обновить `web/frontend/src/api/services.ts` для работы с tenant схемами
- [ ] Обновить `web/frontend/src/api/masters.ts` для работы с tenant схемами
- [ ] Обновить `web/frontend/src/api/clients.ts` для работы с tenant схемами
- [ ] Обновить `web/frontend/src/api/posts.ts` для работы с tenant схемами
- [ ] Обновить остальные API файлы

**Требования:**
- Добавить interceptor для добавления `X-Company-ID` header
- Проверять наличие `company_id` в localStorage/sessionStorage
- Передавать `company_id` в headers всех запросов
- Логировать все запросы с `company_id`

### Шаг 10.2: Обновить хендлеры Dashboard для работы с tenant схемами

**Задачи:**
- [ ] Обновить `web/frontend/src/pages/Dashboard.tsx` для работы с `company_id`
- [ ] Обновить статистику для текущей компании только
- [ ] Обновить графики для текущей компании только
- [ ] Проверять подписку перед операциями (если истекла → блокировать)

**Требования:**
- Статистика только для текущей компании
- Графики доходов только для текущей компании
- Блокировка операций при истекшей подписке
- Отображение статуса подписки

### Шаг 10.3: Обновить все CRUD хендлеры для работы с tenant схемами

**Задачи:**
- [ ] Обновить все хендлеры для работы с `company_id`
- [ ] Добавить проверку подписки перед созданием записей
- [ ] Блокировать функции при истекшей подписке
- [ ] Добавить сообщения об истекшей подписке

**Требования:**
- Передача `company_id` в headers
- Проверять `can_create_bookings` перед созданием записей
- Отображать сообщения об ошибке подписки
- Обновление localStorage/sessionStorage с `company_id`

### Шаг 10.4: Добавить проверку статуса подписки компании

**Задачи:**
- [ ] Добавить проверку `subscription_status` в `can_create_bookings`
- [ ] Блокировать создание записей если подписка истекла
- [ ] Показывать предупреждения о приближающемся окончании

**Требования:**
- Проверять статус подписки компании
- Блокировать функции при истекшей подписке
- Отображать статус подписки на Dashboard
- Отправлять уведомления о необходимости продления

---

## 📝 Чек-лист завершения

### Шаг 10.1: Обновление API клиентов
- [ ] Обновить `api/client.ts` для добавления `company_id`
- [ ] Обновить все API файлы

### Шаг 10.2: Обновление хендлеров Dashboard
- [ ] Обновить `Dashboard.tsx` для работы с `company_id`
- [ ] Обновить статистику для текущей компании

### Шаг 10.3: Обновление всех CRUD хендлеров
- [ ] Обновить все хендлеры для работы с `company_id`
- [ ] Добавить проверку подписки перед операциями

### Шаг 10.4: Проверка статуса подписки
- [ ] Добавить проверку подписки
- [ ] Блокировать функции при истекшей подписке

---

## 📊 План работ

### День 1
- Утро: Обновление API клиентов
- День: Обновление хендлеров Dashboard
- Вечер: Обновление всех CRUD хендлеров

### День 2
- Утро: Добавление проверки подписки
- День: Тестирование всех сценариев
- Вечер: Фикс багов

---

## 🎯 Ожидаемые результаты

- Полноценная адаптация админ-панели для работы с tenant схемами
- Передача `company_id` во все запросы к API
- Проверка подписки перед операциями
- Блокировка функций при истекшей подписке
- Изоляция данных между компаниями

---

**Примечание:** Этап включает адаптацию существующей админ-панели. Большая часть функционала уже реализована, нужно обновить для работы с tenant схемами.


# –≠—Ç–∞–ø 5: Backend - API –¥–ª—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞

**–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** 2 –¥–Ω—è  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω (MVP)  
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2026-01-14  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–¶–µ–ª—å —ç—Ç–∞–ø–∞](#—Ü–µ–ª—å-—ç—Ç–∞–ø–∞)
2. [–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è](#–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)
3. [–ü–æ–¥–∑–∞–¥–∞—á–∏](#–ø–æ–¥–∑–∞–¥–∞—á–∏)
4. [–ß–µ–∫-–ª–∏—Å—Ç —ç—Ç–∞–ø–∞](#—á–µ–∫-–ª–∏—Å—Ç-—ç—Ç–∞–ø–∞)
5. [–†–∏—Å–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ](#—Ä–∏—Å–∫–∏-–∏-–∏—Ö-—Ä–µ—à–µ–Ω–∏–µ)

---

## üéØ –¶–µ–ª—å —ç—Ç–∞–ø–∞

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API –¥–ª—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏, –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏.

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

- API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏—è–º–∏
- API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
- API –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–∏–ª–ª–∏–Ω–≥–∞
- API –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ Excel
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞

---

## üîß –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞–±–æ—Ç—ã

- [ ] –≠—Ç–∞–ø 2 –∑–∞–≤–µ—Ä—à–µ–Ω (–º–æ–¥–µ–ª–∏ –∏ —Å—Ö–µ–º—ã —Å–æ–∑–¥–∞–Ω—ã)
- [ ] –≠—Ç–∞–ø 4 –∑–∞–≤–µ—Ä—à–µ–Ω (–ø—É–±–ª–∏—á–Ω—ã–µ API —Ä–∞–±–æ—Ç–∞—é—Ç)
- [ ] –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω —Å–æ–∑–¥–∞–Ω —á–µ—Ä–µ–∑ —Å–∫—Ä–∏–ø—Ç
- [ ] –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ –±–∏–ª–ª–∏–Ω–≥–∞

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.11+ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
- –î–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —Å pandas (–¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel)

---

## üìù –ü–æ–¥–∑–∞–¥–∞—á–∏

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 5.1: –°–æ–∑–¥–∞—Ç—å super_admin.py API –º–æ–¥—É–ª—å

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/api/super_admin.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–æ—É—Ç–µ—Ä:
   ```python
   from fastapi import APIRouter, Depends, HTTPException, Query
   from sqlalchemy.ext.asyncio import AsyncSession
   from sqlalchemy import select, func
   from typing import Optional, List
   from datetime import date, datetime, timedelta

   router = APIRouter(prefix="/api/super-admin", tags=["super_admin"])
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –ú–æ–¥—É–ª—å —Å–æ–∑–¥–∞–Ω
- [ ] –†–æ—É—Ç–µ—Ä –æ–ø—Ä–µ–¥–µ–ª–µ–Ω
- [ ] –ü—Ä–µ—Ñ–∏–∫—Å /api/super-admin
- [ ] –¢–µ–≥ "super_admin" –¥–æ–±–∞–≤–ª–µ–Ω

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 5.2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–∞—à–±–æ—Ä–¥–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å endpoint —Å –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –ø–æ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å Pydantic —Å—Ö–µ–º—É:
   ```python
   class DashboardStatsResponse(BaseModel):
       total_companies: int
       active_companies: int
       overdue_companies: int
       blocked_companies: int
       total_revenue_all_time: Decimal
       revenue_this_month: Decimal
       revenue_today: Decimal
       total_payments: int
       new_companies_this_month: int
       total_users: int
       total_bookings: int
   
       class Config:
           from_attributes = True
   ```

2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint:
   ```python
   @router.get("/dashboard/stats", response_model=DashboardStatsResponse)
   async def get_dashboard_stats(
       db: AsyncSession = Depends(get_db),
       current_user: User = Depends(get_current_super_admin)
   ):
       """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–∞—à–±–æ—Ä–¥–∞ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞"""
       
       # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π
       total_companies = await db.scalar(
           select(func.count(Company.id))
       ) or 0
       
       # –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
       active_companies = await db.scalar(
           select(func.count(Company.id)).where(
               Company.is_active == True,
               Company.subscription_status == 'active'
           )
       ) or 0
       
       # –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
       overdue_companies = await db.scalar(
           select(func.count(Company.id)).where(
               Company.is_active == True,
               Company.subscription_status == 'overdue'
           )
       ) or 0
       
       # –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏
       blocked_companies = await db.scalar(
           select(func.count(Company.id)).where(
               Company.is_active == False
           )
       ) or 0
       
       # –û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞ (–≤—Å–µ –≤—Ä–µ–º—è)
       total_revenue_all_time = await db.scalar(
           select(func.sum(Payment.amount)).where(Payment.status == 'completed')
       ) or Decimal('0.00')
       
       # –í—ã—Ä—É—á–∫–∞ –∑–∞ —ç—Ç–æ—Ç –º–µ—Å—è—Ü
       first_day_month = date.today().replace(day=1)
       revenue_this_month = await db.scalar(
           select(func.sum(Payment.amount)).where(
               Payment.status == 'completed',
               Payment.payment_date >= first_day_month
           )
       ) or Decimal('0.00')
       
       # –í—ã—Ä—É—á–∫–∞ —Å–µ–≥–æ–¥–Ω—è
       today = date.today()
       revenue_today = await db.scalar(
           select(func.sum(Payment.amount)).where(
               Payment.status == 'completed',
               Payment.payment_date >= today
           )
       ) or Decimal('0.00')
       
       # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π
       total_payments = await db.scalar(
           select(func.count(Payment.id))
       ) or 0
       
       # –ù–æ–≤—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∑–∞ –º–µ—Å—è—Ü
       new_companies_this_month = await db.scalar(
           select(func.count(Company.id)).where(
               Company.created_at >= first_day_month
           )
       ) or 0
       
       # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Å—É–º–º–∞ –ø–æ –≤—Å–µ–º –∫–æ–º–ø–∞–Ω–∏—è–º)
       # –≠—Ç–æ —Å–ª–æ–∂–Ω–µ–µ, –º–æ–∂–Ω–æ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å None
       total_users = None  # TODO: –ø–æ—Å—á–∏—Ç–∞—Ç—å —á–µ—Ä–µ–∑ JOIN —Å tenant-—Å—Ö–µ–º–∞–º–∏
       
       # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)
       total_bookings = None  # TODO: –ø–æ—Å—á–∏—Ç–∞—Ç—å —á–µ—Ä–µ–∑ JOIN —Å tenant-—Å—Ö–µ–º–∞–º–∏
       
       return DashboardStatsResponse(
           total_companies=total_companies,
           active_companies=active_companies,
           overdue_companies=overdue_companies,
           blocked_companies=blocked_companies,
           total_revenue_all_time=total_revenue_all_time,
           revenue_this_month=revenue_this_month,
           revenue_today=revenue_today,
           total_payments=total_payments,
           new_companies_this_month=new_companies_this_month,
           total_users=total_users,
           total_bookings=total_bookings
       )
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] Endpoint —Å–æ–∑–¥–∞–Ω
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [ ] –í—ã—Ä—É—á–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤–µ—Ä–Ω–æ
- [ ] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π –≤–µ—Ä–Ω–æ
- [ ] –¢–æ–ª—å–∫–æ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 5.3: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API –∫–æ–º–ø–∞–Ω–∏–π

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å CRUD endpoints –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏—è–º–∏.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–ø–∞–Ω–∏–π:
   ```python
   @router.get("/companies")
   async def get_companies(
       page: int = Query(1, ge=1),
       page_size: int = Query(20, ge=1, le=100),
       is_active: Optional[bool] = None,
       subscription_status: Optional[str] = None,
       search: Optional[str] = None,
       db: AsyncSession = Depends(get_db),
       current_user: User = Depends(get_current_super_admin)
   ):
       """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π"""
       query = select(Company)
       
       conditions = []
       if is_active is not None:
           conditions.append(Company.is_active == is_active)
       if subscription_status is not None:
           conditions.append(Company.subscription_status == subscription_status)
       if search:
           search_term = f"%{search}%"
           conditions.append(Company.name.ilike(search_term))
       
       if conditions:
           query = query.where(and_(*conditions))
       
       # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
       count_query = select(func.count(Company.id))
       if conditions:
           count_query = count_query.where(and_(*conditions))
       
       total = await db.scalar(count_query) or 0
       
       # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
       query = query.offset((page - 1) * page_size).limit(page_size)
       query = query.order_by(Company.created_at.desc())
       
       result = await db.execute(query)
       companies = result.scalars().all()
       
       return {
           "items": companies,
           "total": total,
           "page": page,
           "page_size": page_size
       }
   ```

2. –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–º–ø–∞–Ω–∏–∏:
   ```python
   @router.get("/companies/{company_id}")
   async def get_company(
       company_id: int,
       db: AsyncSession = Depends(get_db),
       current_user: User = Depends(get_current_super_admin)
   ):
       """–ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–ø–∞–Ω–∏–∏"""
       from sqlalchemy.orm import selectinload
       
       query = select(Company).options(
           selectinload(Company.subscriptions),
           selectinload(Company.payments)
       ).where(Company.id == company_id)
       
       result = await db.execute(query)
       company = result.scalar_one_or_none()
       
       if not company:
           raise HTTPException(status_code=404, detail="–ö–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
       
       return company
   ```

3. –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏:
   ```python
   @router.patch("/companies/{company_id}/block")
   async def block_company(
       company_id: int,
       block_type: str = Body(..., embed=True, description="–¢–∏–ø –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: bookings_only –∏–ª–∏ full"),
       db: AsyncSession = Depends(get_db),
       current_user: User = Depends(get_current_super_admin)
   ):
       """–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é"""
       
       result = await db.execute(
           select(Company).where(Company.id == company_id)
       )
       company = result.scalar_one_or_none()
       
       if not company:
           raise HTTPException(status_code=404, detail="–ö–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
       
       if block_type.block_type == "bookings_only":
           # –ë–ª–æ–∫–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π
           company.can_create_bookings = False
           company.subscription_status = 'overdue'
       elif block_type.block_type == "full":
           # –ü–æ–ª–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
           company.is_active = False
           company.subscription_status = 'blocked'
       else:
           raise HTTPException(
               status_code=400,
               detail="–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: bookings_only –∏–ª–∏ full"
           )
       
       await db.commit()
       await db.refresh(company)
       
       return {
           "status": "success",
           "message": f"–ö–æ–º–ø–∞–Ω–∏—è {company.name} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞",
           "block_type": block_type.block_type
       }
   ```

4. –°–æ–∑–¥–∞—Ç—å endpoint –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:
   ```python
   @router.patch("/companies/{company_id}/unblock")
   async def unblock_company(
       company_id: int,
       db: AsyncSession = Depends(get_db),
       current_user: User = Depends(get_current_super_admin)
   ):
       """–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é"""
       
       result = await db.execute(
           select(Company).where(Company.id == company_id)
       )
       company = result.scalar_one_or_none()
       
       if not company:
           raise HTTPException(status_code=404, detail="–ö–æ–º–ø–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
       
       company.is_active = True
       company.can_create_bookings = True
       company.subscription_status = 'active'
       
       await db.commit()
       await db.refresh(company)
       
       return {
           "status": "success",
           "message": f"–ö–æ–º–ø–∞–Ω–∏—è {company.name} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞"
       }
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –°–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –§–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç (bookings_only)
- [ ] –ü–æ–ª–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 5.4: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å API –±–∏–ª–ª–∏–Ω–≥–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å endpoints –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π –∏ –∏—Ö –ø—Ä–æ—Å–º–æ—Ç—Ä–∞.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:
   ```
   web/backend/app/api/billing.py
   ```

2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–æ—É—Ç–µ—Ä:
   ```python
   from fastapi import APIRouter, Depends, HTTPException, Query
   from sqlalchemy.ext.asyncio import AsyncSession
   from sqlalchemy import select, func
   from typing import Optional
   from datetime import date, datetime
   from decimal import Decimal

   router = APIRouter(prefix="/api/super-admin/billing", tags=["billing"])
   ```

3. –°–æ–∑–¥–∞—Ç—å endpoint —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–∏–ª–ª–∏–Ω–≥–∞:
   ```python
   @router.get("/stats")
   async def get_billing_stats(
       start_date: Optional[date] = None,
       end_date: Optional[date] = None,
       company_id: Optional[int] = None,
       db: AsyncSession = Depends(get_db),
       current_user: User = Depends(get_current_super_admin)
   ):
       """–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±–∏–ª–ª–∏–Ω–≥–∞"""
       
       # –ë–∞–∑–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è —Å—É–º–º—ã
       sum_query = select(
           func.sum(Payment.amount),
           func.count(Payment.id)
       ).where(Payment.status == 'completed')
       
       # –§–∏–ª—å—Ç—Ä—ã
       if start_date:
           sum_query = sum_query.where(Payment.payment_date >= start_date)
       if end_date:
           sum_query = sum_query.where(Payment.payment_date <= end_date)
       if company_id:
           sum_query = sum_query.where(Payment.company_id == company_id)
       
       result = await db.execute(sum_query)
       total_amount, count = result.first()
       
       # –í—ã—Ä—É—á–∫–∞ –ø–æ –ø–ª–∞–Ω–∞–º
       by_plan_query = select(
           Plan.name,
           func.sum(Payment.amount),
           func.count(Payment.id)
       ).join(Payment.subscription, Subscription.plan, Plan).where(
           Payment.status == 'completed'
       ).group_by(Plan.id, Plan.name)
       
       if start_date:
           by_plan_query = by_plan_query.where(Payment.payment_date >= start_date)
       if end_date:
           by_plan_query = by_plan_query.where(Payment.payment_date <= end_date)
       if company_id:
           by_plan_query = by_plan_query.where(Payment.company_id == company_id)
       
       by_plan_result = await db.execute(by_plan_query)
       by_plan_data = [
           {"plan_name": row[0], "revenue": row[1], "count": row[2]}
           for row in by_plan_result
       ]
       
       return {
           "total_revenue": total_amount or Decimal('0.00'),
           "total_payments": count or 0,
           "by_plan": by_plan_data
       }
   ```

4. –°–æ–∑–¥–∞—Ç—å endpoint —Å–ø–∏—Å–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π:
   ```python
   @router.get("/payments")
   async def get_payments(
       page: int = Query(1, ge=1),
       page_size: int = Query(20, ge=1, le=100),
       company_id: Optional[int] = None,
       status: Optional[str] = None,
       start_date: Optional[date] = None,
       end_date: Optional[date] = None,
       db: AsyncSession = Depends(get_db),
       current_user: User = Depends(get_current_super_admin)
   ):
       """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π"""
       from sqlalchemy.orm import selectinload
       
       query = select(Payment).options(
           selectinload(Payment.company),
           selectinload(Payment.subscription)
       )
       
       conditions = []
       if company_id:
           conditions.append(Payment.company_id == company_id)
       if status:
           conditions.append(Payment.status == status)
       if start_date:
           conditions.append(Payment.payment_date >= start_date)
       if end_date:
           conditions.append(Payment.payment_date <= end_date)
       
       if conditions:
           query = query.where(and_(*conditions))
       
       # –ü–æ–¥—Å—á–µ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
       count_query = select(func.count(Payment.id))
       if conditions:
           count_query = count_query.where(and_(*conditions))
       
       total = await db.scalar(count_query) or 0
       
       # –ü–∞–≥–∏–Ω–∞—Ü–∏—è
       query = query.offset((page - 1) * page_size).limit(page_size)
       query = query.order_by(Payment.created_at.desc())
       
       result = await db.execute(query)
       payments = result.scalars().all()
       
       return {
           "items": payments,
           "total": total,
           "page": page,
           "page_size": page_size
       }
   ```

5. –°–æ–∑–¥–∞—Ç—å endpoint —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ Excel:
   ```python
   import pandas as pd
   from fastapi.responses import StreamingResponse
   import io
   
   @router.post("/export")
   async def export_payments(
       start_date: Optional[date] = None,
       end_date: Optional[date] = None,
       company_id: Optional[int] = None,
       db: AsyncSession = Depends(get_db),
       current_user: User = Depends(get_current_super_admin)
   ):
       """–≠–∫—Å–ø–æ—Ä—Ç –ø–ª–∞—Ç–µ–∂–µ–π –≤ Excel"""
       from sqlalchemy.orm import selectinload
       
       # –ü–æ–ª—É—á–∞–µ–º –ø–ª–∞—Ç–µ–∂–∏
       query = select(Payment).options(
           selectinload(Payment.company),
           selectinload(Payment.subscription)
       )
       
       conditions = [Payment.status == 'completed']
       if start_date:
           conditions.append(Payment.payment_date >= start_date)
       if end_date:
           conditions.append(Payment.payment_date <= end_date)
       if company_id:
           conditions.append(Payment.company_id == company_id)
       
       query = query.where(and_(*conditions))
       query = query.order_by(Payment.payment_date.desc())
       
       result = await db.execute(query)
       payments = result.scalars().all()
       
       # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è Excel
       data = []
       for payment in payments:
           data.append({
               "ID": payment.id,
               "–ö–æ–º–ø–∞–Ω–∏—è": payment.company.name if payment.company else "N/A",
               "–°—É–º–º–∞": float(payment.amount),
               "–í–∞–ª—é—Ç–∞": payment.currency,
               "–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã": payment.payment_date.strftime('%d.%m.%Y %H:%M') if payment.payment_date else "N/A",
               "–ú–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã": payment.payment_method,
               "–°—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞": payment.yookassa_payment_status,
               "–°—Ç–∞—Ç—É—Å": payment.status
           })
       
       # –°–æ–∑–¥–∞–µ–º DataFrame
       df = pd.DataFrame(data)
       
       # –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ Excel
       output = io.BytesIO()
       with pd.ExcelWriter(output, engine='openpyxl') as writer:
           df.to_excel(writer, index=False, sheet_name='–ü–ª–∞—Ç–µ–∂–∏')
       
       output.seek(0)
       
       filename = f"payments_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
       
       return StreamingResponse(
           content=output.read(),
           media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
           headers={
               "Content-Disposition": f"attachment; filename={filename}"
           }
       )
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∏–ª–ª–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –§–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –§–∞–π–ª —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 5.5: –°–æ–∑–¥–∞—Ç—å get_current_super_admin –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å

**–û–ø–∏—Å–∞–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤ dependencies.py:
   ```python
   async def get_current_super_admin(
       db: AsyncSession = Depends(get_db),
       token: str = Depends(oauth2_scheme)
   ) -> SuperAdmin:
       """–ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞"""
       
       payload = decode_access_token(token)
       telegram_id = payload.get("telegram_id")
       
       if not telegram_id:
           raise HTTPException(
               status_code=401,
               detail="–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
           )
       
       # –ò—â–µ–º —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞
       result = await db.execute(
           select(SuperAdmin).where(SuperAdmin.telegram_id == telegram_id)
       )
       super_admin = result.scalar_one_or_none()
       
       if not super_admin:
           raise HTTPException(
               status_code=403,
               detail="–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞"
           )
       
       return super_admin
   ```

2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–æ –≤—Å–µ—Ö endpoints —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞:
   ```python
   @router.get("/dashboard/stats")
   async def get_dashboard_stats(
       current_user: User = Depends(get_current_super_admin),
       db: AsyncSession = Depends(get_db)
   ):
       # ...
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö endpoints
- [ ] 403 –æ—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

### –ü–æ–¥–∑–∞–¥–∞—á–∞ 5.6: –î–æ–±–∞–≤–∏—Ç—å API —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞ –≤ main.py

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å API –º–æ–¥—É–ª–∏ –≤ –≥–ª–∞–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

1. –û–±–Ω–æ–≤–∏—Ç—å web/backend/main.py:
   ```python
   from app.api.super_admin import router as super_admin_router
   from app.api.billing import router as billing_router
   
   # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ä–æ—É—Ç–µ—Ä—ã
   app.include_router(super_admin_router)
   app.include_router(billing_router)
   ```

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:**
- [ ] API –º–æ–¥—É–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [ ] Endpoints –¥–æ—Å—Ç—É–ø–Ω—ã
- [ ] Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –†–æ—É—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç —ç—Ç–∞–ø–∞

### API –º–æ–¥—É–ª–∏

- [ ] super_admin.py —Å–æ–∑–¥–∞–Ω
- [ ] billing.py —Å–æ–∑–¥–∞–Ω
- [ ] –í—Å–µ —Ä–æ—É—Ç–µ—Ä—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞

- [ ] –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –í—ã—Ä—É—á–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤–µ—Ä–Ω–æ
- [ ] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–ø–∞–Ω–∏–π –≤–µ—Ä–Ω–æ
- [ ] –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π –≤–µ—Ä–Ω–æ

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏—è–º–∏

- [ ] –°–ø–∏—Å–æ–∫ –∫–æ–º–ø–∞–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –§–∏–ª—å—Ç—Ä—ã —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ bookings_only —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ü–æ–ª–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ë–∏–ª–ª–∏–Ω–≥

- [ ] –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∏–ª–ª–∏–Ω–≥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –§–∏–ª—å—Ç—Ä—ã –ø–æ –¥–∞—Ç–µ —Ä–∞–±–æ—Ç–∞—é—Ç
- [ ] –§–∏–ª—å—Ç—Ä –ø–æ –∫–æ–º–ø–∞–Ω–∏–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

- [ ] get_current_super_admin —Å–æ–∑–¥–∞–Ω–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] 403 –æ—à–∏–±–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

- [ ] API –º–æ–¥—É–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ main.py
- [ ] Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –í—Å–µ endpoints –¥–æ—Å—Ç—É–ø–Ω—ã

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- [ ] API –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] –ü–∞–≥–∏–Ω–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω
- [ ] –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö

---

## ‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏–µ

### –†–∏—Å–∫ 1: –°–ª–æ–∂–Ω—ã–π —Ä–∞—Å—á–µ—Ç –æ–±—â–µ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è  
**–í–ª–∏—è–Ω–∏–µ:** –ù–∏–∑–∫–æ–µ

**–ú–µ—Ä—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:**
- –£–ø—Ä–æ—â–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–æ–≤
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç

**–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏:**
- –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ cron –∑–∞–¥–∞—á–∏
- –•—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥—Ä–∞—Å—á–∏—Ç–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- –£–ª—É—á—à–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

---

### –†–∏—Å–∫ 2: –ü—Ä–æ–±–ª–µ–º—ã —Å —ç–∫—Å–ø–æ—Ä—Ç–æ–º –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤

**–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è  
**–í–ª–∏—è–Ω–∏–µ:** –°—Ä–µ–¥–Ω–µ–µ

**–ú–µ—Ä—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:**
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ—Ç–æ–∫–æ–≤
- –ü–∞–≥–∏–Ω–∞—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞

**–†–µ—à–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏:**
- –†–∞–∑–±–∏–≤–∫–∞ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤
- –õ–∏–º–∏—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –§–æ–Ω–æ–≤–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏:
   ```bash
   docker compose logs web -f | grep super_admin
   ```

2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API:
   ```bash
   curl http://localhost:8000/api/super-admin/dashboard/stats
   ```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Swagger:
   ```
   http://localhost:8000/docs
   ```

---

**–≠—Ç–∞–ø 5 –∑–∞–≤–µ—Ä—à–µ–Ω:** [ ]  
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** _________  
**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:** _________________


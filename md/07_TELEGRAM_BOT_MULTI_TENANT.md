# Этап 7: Telegram Bot мульти-тенантность

**Продолжительность:** 2-3 дня  
**Статус:** ⏳ В ожидании  
**Приоритет:** Средний  

---

## 🎯 Цель

Обновить существующие Telegram боты для работы с мульти-тенантной архитектурой.

---

## 📦 Требования

### 1. Функционал

#### ✅ Обновление хендлеров для работы с tenant схемами
- Каждый бот работает только со своей tenant схемой
- Контекст компании сохраняется в диспетчере
- Изоляция данных между ботами

#### ✅ Проверка статуса подписки перед созданием записей
- Блокировка создания записей при истекшей подписке
- Отправка уведомлений пользователю
- Предоставление инструкции по продлению

#### ✅ Интеграция SubscriptionMiddleware
- Автоматическая проверка статуса подписки
- Блокировка команд, связанных с созданием записей
- Отправка предупреждений при приближающемся окончании

### 2. Компоненты

#### BotManager (существующий)
- ✅ `bot/bot_manager.py` - менеджер для управления всеми ботами
- ✅ Загрузка активных компаний из `public` схемы
- ✅ Создание и запуск отдельных ботов для каждой компании
- ✅ Сохранение контекста в диспетчерах

#### SubscriptionMiddleware (новый)
- ✅ `bot/middleware/subscription.py` - middleware для проверки статуса подписки
- ✅ Проверка `can_create_bookings` перед выполнением команд
- ✅ Блокировка создания записей при истекшей подписке
- ✅ Отправка предупреждений при приближающемся окончании (≤7 дней)

#### Проверка подписки в хендлерах (существующий)
- ✅ `bot/handlers/booking_subscription_check.py` - проверка подписки
- ✅ `check_subscription_before_booking()` - проверка перед созданием записей
- ✅ Отправка информативных сообщений об истекшей подписке

### 3. Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│              Telegram Bot Architecture          │
│                                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  BotManager                      │   │
│  │    (Загружает компании, создает боты)           │   │
│  └─────────────────────────────────────────────────────┘   │
│           │                                                 │
│           ▼                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                Company 1 Bot              │   │
│  │  - company_id=1                                    │   │
│  │  - schema_name='tenant_1'                           │   │
│  │  - can_create_bookings=True                          │   │
│  │  - subscription_status='active'                        │   │
│  └─────────────────────────────────────────────────────┘   │
│           │                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                Company 2 Bot              │   │
│  │  - company_id=2                                    │   │
│  │  - schema_name='tenant_2'                           │   │
│  │  - can_create_bookings=False                          │   │
│  │  - subscription_status='expired'                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │            SubscriptionMiddleware                     │   │
│  │   (Проверяет can_create_bookings перед командами)   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                           │
└─────────────────────────────────────────────────────────────────┘
```

**Механизм работы:**
1. **Загрузка компаний:** `BotManager` загружает активные компании из `public` схемы
2. **Создание ботов:** Для каждой компании создается отдельный `Bot` и `Dispatcher`
3. **Контекст диспетчера:** В каждый `Dispatcher` сохраняются:
   - `company_id` - ID компании
   - `company_name` - Название компании
   - `schema_name` - Имя tenant схемы
   - `can_create_bookings` - Может ли создавать записи
   - `subscription_status` - Статус подписки
   - `subscription_end_date` - Дата окончания подписки
   - `admin_telegram_ids` - Список админов
4. **Middleware:** `SubscriptionMiddleware` проверяет `can_create_bookings` перед командами
5. **Блокировка:** При `can_create_bookings=False` блокируются команды создания записей
6. **Изоляция:** Каждый бот работает только со своей tenant схемой

---

## 🚀 Реализация

### Шаг 7.1: Обновить SubscriptionMiddleware

**Задачи:**
- [x] Создать `bot/middleware/subscription.py`
- [x] Реализовать `SubscriptionMiddleware` класс
- [x] Проверка `can_create_bookings` из контекста диспетчера
- [x] Блокировка команд создания записей при `can_create_bookings=False`
- [x] Отправка уведомлений при истекшей подписке
- [x] Отправка предупреждений при приближающемся окончании (≤7 дней)

**Требования:**
- Использовать `dispatcher.data` для доступа к контексту
- Работать с `Message` и `CallbackQuery`
- Логировать все проверки
- Отправлять информативные сообщения на русском

### Шаг 7.2: Интегрировать SubscriptionMiddleware в боте

**Задачи:**
- [x] Импортировать `SubscriptionMiddleware` в `bot/main.py`
- [x] Применить middleware к диспетчеру
- [x] Логировать применение middleware

**Требования:**
- Применить к `message` и `callback_query` типам событий
- Логировать успешное применение
- Сохранять контекст в диспетчере

### Шаг 7.3: Обновить хендлеры для использования статуса подписки

**Задачи:**
- [x] Исправить ошибки в `check_subscription_before_booking()`
- [x] Исправить `dp.get` на `dp.data.get`
- [x] Проверить использование контекста диспетчера
- [x] Обновить сообщения об ошибках

**Требования:**
- Использовать `dp.data.get` вместо `dp.get`
- Проверять `can_create_bookings` перед созданием записей
- Отправлять информативные сообщения об истекшей подписке
- Логировать все проверки

### Шаг 7.4: Обновить сообщения об ошибках

**Задачи:**
- [x] Проверить все сообщения об истекшей подписке
- [x] Добавить ссылки на админ-панель
- [x] Предоставить инструкции по продлению

**Требования:**
- Сообщения на русском языке
- Информативные и понятные
- Ссылки на админ-панель
- Инструкции по продлению

---

## 📝 Чек-лист завершения

### Шаг 7.1: Обновление SubscriptionMiddleware
- [x] Создать `bot/middleware/subscription.py`
- [x] Реализовать `SubscriptionMiddleware` класс
- [x] Проверка `can_create_bookings`
- [x] Блокировка команд при истекшей подписке
- [x] Отправка уведомлений
- [x] Отправка предупреждений (≤7 дней)

### Шаг 7.2: Интеграция SubscriptionMiddleware
- [x] Импортировать `SubscriptionMiddleware`
- [x] Применить к диспетчеру
- [x] Логировать применение

### Шаг 7.3: Обновление хендлеров
- [x] Исправить `check_subscription_before_booking()`
- [x] Исправить `dp.get` на `dp.data.get`
- [x] Проверить использование контекста
- [x] Обновить сообщения об ошибках

### Шаг 7.4: Обновление сообщений об ошибках
- [x] Проверить все сообщения об истекшей подписке
- [x] Добавить ссылки на админ-панель
- [x] Предоставить инструкции по продлению

---

## 📊 План работ

### День 1
- Утро: Обновление SubscriptionMiddleware
- День: Интеграция в боте
- Вечер: Обновление хендлеров

### День 2
- Утро: Обновление сообщений об ошибках
- День: Тестирование всех сценариев
- Вечер: Фикс багов

---

## 🎯 Ожидаемые результаты

- Полноценная мульти-бот архитектура
- Автоматическая проверка статуса подписки
- Блокировка создания записей при истекшей подписке
- Отправка предупреждений и инструкций
- Изоляция данных между ботами

---

**Примечание:** Основная архитектура бота уже реализована. Этот этап фокусируется на обновлении middleware и сообщений об ошибках.


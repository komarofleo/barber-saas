# Этап 5: Мульти-боты

**Продолжительность:** 2-3 дня  
**Статус:** ✅ Завершен (MVP)  
**Дата завершения:** 2026-01-14  
**Приоритет:** Средний  

---

## 🎯 Цель

Создать мульти-бот архитектуру для управления несколькими Telegram ботами для разных компаний.

---

## 📦 Требования

### 1. Функционал

#### ✅ Управление несколькими ботами для разных компаний
- Автоматический запуск ботов для всех активных компаний
- Управление lifecycle ботов (запуск, остановка, перезапуск)
- Изоляция данных между ботами (каждый бот работает с своей tenant схемой)

#### ✅ Бот супер-админа
- Отдельный бот для управления всеми компаниями
- Показ статистики по всем компаниям
- Управление ботами (запуск/остановка/перезапуск)
- Отправка напоминаний о подписках
- Админ-панель через Telegram

#### ✅ Проверка статуса подписки в боте
- Проверка статуса подписки перед созданием записей
- Блокировка команд при истекшей подписке
- Отправка уведомлений о приближающемся окончании
- Разблокировка при продлении подписки

### 2. Компоненты

#### BotManager
- ✅ `bot/bot_manager.py` - менеджер для управления всеми ботами
- ✅ `bot/main.py` - запуск отдельных ботов для каждой компании
- ✅ `bot/bot_manager.py` методы:
  - `load_active_companies()` - загрузить активные компании
  - `create_bot_instance(company)` - создать экземпляр бота
  - `start_bot(bot_instance)` - запустить бота
  - `stop_bot(bot_instance)` - остановить бота
  - `restart_bot(company_id)` - перезапустить бота
  - `get_bot_status(company_id)` - получить статус бота
  - `start_all_bots()` - запустить всех ботов
  - `stop_all_bots()` - остановить всех ботов

#### Bot API (backend)
- ✅ `web/backend/app/api/bot_manager.py` - API для управления ботами
  - `GET /api/bot-manager/status` - статус всех ботов
  - `GET /api/bot-manager/status/{company_id}` - статус бота компании
  - `POST /api/bot-manager/start-all` - запуск всех ботов
  - `POST /api/bot-manager/stop-all` - останов всех ботов
  - `POST /api/bot-manager/restart/{company_id}` - перезапуск бота
  - `POST /api/bot-manager/stop/{company_id}` - останов бота
  - `POST /api/bot-manager/start/{company_id}` - запуск бота
  - `GET /api/bot-manager/stats` - статистика дэшборда

#### Super Admin Bot
- ✅ `bot/super_admin_bot.py` - бот супер-админа
  - Команды: `/start`, `/stats`, `/companies`, `/expiring`
  - FSM для управления состоянием
  - Inline клавиатуры для навигации
  - Проверка прав доступа (только супер-админ)

#### SubscriptionMiddleware
- ✅ `bot/middleware/subscription.py` - middleware для проверки статуса подписки
  - Проверка `can_create_bookings` перед выполнением команд
  - Блокировка создания записей при истекшей подписке
  - Отправка уведомлений о приближающемся окончании
  - Разблокировка при продлении подписки

### 3. Архитектура

```
┌─────────────────────────────────────────────────────────────────┐
│                 Bot Manager System              │
│                                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                  BotManager                      │   │
│  │    (Управление всеми ботами)               │   │
│  └─────────────────────────────────────────────────────┘   │
│           │                  │                 │            │
│           ▼                  ▼                 ▼            │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐   │
│  │ Bot Comp 1│  │ Bot Comp 2│  │ Bot Comp N│   │
│  │ (tenant_1) │  │ (tenant_2) │  │ (tenant_N) │   │
│  └────────────┘  └────────────┘  └────────────┘   │
│                                                           │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │           Super Admin Bot                     │   │
│  │    (Управление через Telegram)               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                           │
└─────────────────────────────────────────────────────────────────┘
```

**Механизм работы:**
1. **Запуск:** `BotManager` загружает активные компании из `public` схемы
2. **Создание:** Для каждой компании создается отдельный экземпляр `Bot` и `Dispatcher`
3. **Контекст:** В каждый `Dispatcher` сохраняется:
   - `company_id` - ID компании
   - `company_name` - Название компании
   - `schema_name` - Имя tenant схемы
   - `can_create_bookings` - Может ли создавать записи
   - `subscription_status` - Статус подписки
4. **Изоляция:** Каждый бот работает только со своей tenant схемой
5. **Бот супер-админа:** Работает с `public` схемой, управляет всеми компаниями

---

## 🚀 Реализация

### Шаг 5.1: Расширить BotManager для работы с public схемой

**Задачи:**
- [x] Создать `bot/bot_manager.py`
- [x] Реализовать `BotInstance` класс
- [x] Реализовать `load_active_companies()` - загрузить активные компании
- [x] Реализовать `create_bot_instance(company)` - создать экземпляр бота
- [x] Реализовать `start_bot(bot_instance)` - запустить бота
- [x] Реализовать `stop_bot(bot_instance)` - остановить бота
- [x] Реализовать `restart_bot(company_id)` - перезапустить бота
- [x] Реализовать `get_bot_status(company_id)` - получить статус бота
- [x] Реализовать `start_all_bots()` - запустить всех ботов
- [x] Реализовать `stop_all_bots()` - останов всех ботов

**Требования:**
- Использовать `Company` модель из `public` схемы
- Сохранять контекст компании в `Dispatcher`
- Работать с `tenant` схемами через `TenantService`
- Логировать все операции

### Шаг 5.2: Создать API для управления ботами

**Задачи:**
- [x] Создать `web/backend/app/api/bot_manager.py`
- [x] `GET /api/bot-manager/status` - статус всех ботов с пагинацией
- [x] `GET /api/bot-manager/status/{company_id}` - статус бота компании
- [x] `POST /api/bot-manager/start-all` - запуск всех ботов
- [x] `POST /api/bot-manager/stop-all` - останов всех ботов
- [x] `POST /api/bot-manager/restart/{company_id}` - перезапуск бота
- [x] `POST /api/bot-manager/stop/{company_id}` - останов бота
- [x] `POST /api/bot-manager/start/{company_id}` - запуск бота
- [x] `GET /api/bot-manager/stats` - статистика дэшборда

**Требования:**
- Использовать `BotManager` для управления ботами
- Проверять права доступа
- Возвращать информацию о компаниях и подписках
- Обеспечить безопасность (только супер-админ)

### Шаг 5.3: Создать Бот супер-админа

**Задачи:**
- [x] Создать `bot/super_admin_bot.py`
- [x] Реализовать команды `/start`, `/stats`, `/companies`, `/expiring`
- [x] Реализовать FSM для управления состоянием
- [x] Добавить Inline клавиатуры для навигации
- [x] Реализовать проверку прав доступа (только супер-админ)
- [x] Добавить команды для управления ботами

**Требования:**
- Работать с `public` схемой
- Использовать `Company`, `Subscription`, `Payment` модели
- Обеспечить безопасное управление
- Предоставлять понятный UI

### Шаг 5.4: Создать SubscriptionMiddleware

**Задачи:**
- [x] Создать `bot/middleware/subscription.py`
- [x] Проверка `can_create_bookings` перед выполнением команд
- [x] Блокировка создания записей при истекшей подписке
- [x] Отправка уведомлений о приближающемся окончании
- [x] Разблокировка при продлении подписки

**Требования:**
- Работать с `Dispatcher` контекстом
- Добавлять информацию о подписке в состояние бота
- Блокировать команды при истекшей подписке
- Логировать проверки

### Шаг 5.5: Интегрировать SubscriptionMiddleware в боте

**Задачи:**
- [ ] Добавить `SubscriptionMiddleware` в `bot/main.py`
- [ ] Обновить хендлеры для использования `can_create_bookings`
- [ ] Добавить проверку подписки перед созданием записей
- [ ] Обновить сообщения об ошибках

**Требования:**
- Использовать `Dispatcher` контекст
- Обновлять сообщения на русском
- Логировать блокировки

---

## 📝 Чек-лист завершения

### Шаг 5.1: Расширение BotManager
- [x] Создать `bot/bot_manager.py`
- [x] Реализовать `BotInstance` класс
- [x] Реализовать `load_active_companies()`
- [x] Реализовать `create_bot_instance(company)`
- [x] Реализовать `start_bot(bot_instance)`
- [x] Реализовать `stop_bot(bot_instance)`
- [x] Реализовать `restart_bot(company_id)`
- [x] Реализовать `get_bot_status(company_id)`
- [x] Реализовать `start_all_bots()`
- [x] Реализовать `stop_all_bots()`

### Шаг 5.2: API для управления ботами
- [x] Создать `web/backend/app/api/bot_manager.py`
- [x] `GET /api/bot-manager/status`
- [x] `GET /api/bot-manager/status/{company_id}`
- [x] `POST /api/bot-manager/start-all`
- [x] `POST /api/bot-manager/stop-all`
- [x] `POST /api/bot-manager/restart/{company_id}`
- [x] `POST /api/bot-manager/stop/{company_id}`
- [x] `POST /api/bot-manager/start/{company_id}`
- [x] `GET /api/bot-manager/stats`

### Шаг 5.3: Бот супер-админа
- [x] Создать `bot/super_admin_bot.py`
- [x] Реализовать команды `/start`, `/stats`, `/companies`, `/expiring`
- [x] Реализовать FSM для управления состоянием
- [x] Добавить Inline клавиатуры для навигации
- [x] Реализовать проверку прав доступа
- [x] Добавить команды для управления ботами

### Шаг 5.4: SubscriptionMiddleware
- [x] Создать `bot/middleware/subscription.py`
- [x] Проверка `can_create_bookings`
- [x] Блокировка создания записей при истекшей подписке
- [x] Отправка уведомлений о приближающемся окончании
- [x] Разблокировка при продлении подписки

### Шаг 5.5: Интеграция SubscriptionMiddleware в боте
- [ ] Добавить `SubscriptionMiddleware` в `bot/main.py`
- [ ] Обновить хендлеры для использования `can_create_bookings`
- [ ] Добавить проверку подписки перед созданием записей
- [ ] Обновить сообщения об ошибках

---

## 📊 План работ

### День 1
- Утро: Расширение BotManager
- День: API для управления ботами
- Вечер: Бот супер-админа

### День 2
- Утро: SubscriptionMiddleware
- День: Интеграция в боте
- Вечер: Тестирование

---

## 🎯 Ожидаемые результаты

- Полноценная система мульти-ботов для всех компаний
- Отдельный бот супер-админа для управления системой
- Автоматический запуск/остановка/перезапуск ботов
- Проверка статуса подписки в боте
- Блокировка команд при истекшей подписке

---

**Примечание:** BotManager и Bot API реализованы, а также Бот супер-админа. Осталось интегрировать SubscriptionMiddleware в боте.


# –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è CRUD –º–æ–¥—É–ª–µ–π - –ó–∞–≤–µ—Ä—à–µ–Ω–æ

**–î–∞—Ç–∞:** 2026-01-14  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ

---

## üìã –¶–µ–ª—å

–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å–ø–æ—Å–æ–± –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è tenant –∏ –ø–æ–ª—É—á–µ–Ω–∏—è tenant —Å–µ—Å—Å–∏–π –≤–æ –≤—Å–µ—Ö CRUD –º–æ–¥—É–ª—è—Ö:
- –ï–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ `company_id` (query ‚Üí request.state ‚Üí JWT)
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `get_tenant_db` dependency –≤–º–µ—Å—Ç–æ —Ä—É—á–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ `search_path`
- –£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –ø–æ–ª—É—á–µ–Ω–∏—è `company_id`

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –°–æ–∑–¥–∞–Ω –µ–¥–∏–Ω—ã–π dependency `get_tenant_db`

**–§–∞–π–ª:** `web/backend/app/deps/tenant.py`

**–§—É–Ω–∫—Ü–∏–∏:**
- `resolve_company_id()` - –µ–¥–∏–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è `company_id`:
  1. Query –ø–∞—Ä–∞–º–µ—Ç—Ä `company_id`
  2. `request.state.company_id` (–∏–∑ middleware)
  3. JWT —Ç–æ–∫–µ–Ω (claim `company_id`)
- `get_tenant_db()` - dependency –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è tenant —Å–µ—Å—Å–∏–∏:
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç `company_id`
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `TenantService.get_tenant_session()`
  - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `search_path` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 2. –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—Å–µ CRUD –º–æ–¥—É–ª–∏

#### ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ (–∏—Å–ø–æ–ª—å–∑—É—é—Ç `get_tenant_db`):
- `clients_tenant.py` - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `services_tenant.py` - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `posts_tenant.py` - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `masters_tenant.py` - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `users_tenant.py` - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `bookings.py` - –æ—Å–Ω–æ–≤–Ω—ã–µ CRUD —Ñ—É–Ω–∫—Ü–∏–∏:
  - `get_bookings()`
  - `get_booking()`
  - `create_booking()`
  - `update_booking()`
  - `get_available_slots()`
- `blocks_tenant.py` - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `promocodes_tenant.py` - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `promotions_tenant.py` - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### ‚ö†Ô∏è –ò—Å–∫–ª—é—á–µ–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑—É—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É):
- `bookings.py` - —Ñ—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
  - `notify_admins_about_new_booking()` - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç `search_path` –º–µ–∂–¥—É public –∏ tenant
  - `send_booking_status_notification()` - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç `search_path` –º–µ–∂–¥—É public –∏ tenant
  - –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –æ–±–µ–∏–º–∏ —Å—Ö–µ–º–∞–º–∏ (public –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è company, tenant –¥–ª—è –¥–∞–Ω–Ω—ã—Ö)

---

## üîß –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### –î–æ (—Å—Ç–∞—Ä—ã–π –ø–æ–¥—Ö–æ–¥):
```python
@router.get("")
async def get_clients(
    request: Request,
    company_id: Optional[int] = Query(None),
    db: AsyncSession = Depends(get_db),
    current_user: User = Depends(get_current_user),
):
    # –ü–æ–ª—É—á–∞–µ–º company_id –∏–∑ —Ç–æ–∫–µ–Ω–∞
    if not company_id:
        company_id = await get_company_id_from_token(request)
    
    if not company_id:
        raise HTTPException(status_code=400, detail="company_id –Ω–µ –Ω–∞–π–¥–µ–Ω")
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º search_path –≤—Ä—É—á–Ω—É—é
    schema_name = f"tenant_{company_id}"
    await db.execute(text(f'SET search_path TO "{schema_name}", public'))
    tenant_session = db
    
    # –†–∞–±–æ—Ç–∞–µ–º —Å –¥–∞–Ω–Ω—ã–º–∏
    ...
```

### –ü–æ—Å–ª–µ (–Ω–æ–≤—ã–π –ø–æ–¥—Ö–æ–¥):
```python
@router.get("")
async def get_clients(
    request: Request,
    tenant_session: AsyncSession = Depends(get_tenant_db),
    current_user: User = Depends(get_current_user),
):
    company_id = getattr(request.state, "company_id", None)
    
    # –†–∞–±–æ—Ç–∞–µ–º —Å –¥–∞–Ω–Ω—ã–º–∏ (search_path —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)
    ...
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –û–±–Ω–æ–≤–ª–µ–Ω–æ –º–æ–¥—É–ª–µ–π: 9
- ‚úÖ clients_tenant.py
- ‚úÖ services_tenant.py
- ‚úÖ posts_tenant.py
- ‚úÖ masters_tenant.py
- ‚úÖ users_tenant.py
- ‚úÖ bookings.py (–æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)
- ‚úÖ blocks_tenant.py
- ‚úÖ promocodes_tenant.py
- ‚úÖ promotions_tenant.py

### –£–¥–∞–ª–µ–Ω–æ –¥—É–±–ª–∏—Ä—É—é—â–µ–≥–æ –∫–æ–¥–∞:
- –£–±—Ä–∞–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ `get_company_id_from_token()` –∏–∑ –∫–∞–∂–¥–æ–≥–æ –º–æ–¥—É–ª—è
- –£–±—Ä–∞–Ω—ã —Ä—É—á–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ `SET search_path`
- –£–±—Ä–∞–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Å—Ö–µ–º—ã (—Ç–µ–ø–µ—Ä—å –≤ `get_tenant_db`)

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–ï–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏–µ:** –í—Å–µ –º–æ–¥—É–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –ø–æ–¥—Ö–æ–¥
2. **–ú–µ–Ω—å—à–µ –∫–æ–¥–∞:** –£–±—Ä–∞–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø–æ–ª—É—á–µ–Ω–∏—è `company_id`
3. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** `get_tenant_db` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã
4. **–ü—Ä–æ—Å—Ç–æ—Ç–∞:** –ù–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å `search_path`
5. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞:** –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ª–æ–≥–∏–∫–µ tenant –¥–µ–ª–∞—é—Ç—Å—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [x] –í—Å–µ CRUD –º–æ–¥—É–ª–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `get_tenant_db`
- [x] –£–±—Ä–∞–Ω—ã –¥—É–±–ª–∏—Ä—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `get_company_id_from_token()`
- [x] –£–±—Ä–∞–Ω—ã —Ä—É—á–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ `SET search_path` (–∫—Ä–æ–º–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤)
- [x] `company_id` –ø–æ–ª—É—á–∞–µ—Ç—Å—è –∏–∑ `request.state` –ø–æ—Å–ª–µ `get_tenant_db`
- [x] –ù–µ—Ç –æ—à–∏–±–æ–∫ –ª–∏–Ω—Ç–µ—Ä–∞
- [x] Backend –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–§—É–Ω–∫—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π** –≤ `bookings.py` –æ—Å—Ç–∞–≤–ª–µ–Ω—ã —Å —Ä—É—á–Ω—ã–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º `search_path`, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –æ–±–µ–∏–º–∏ —Å—Ö–µ–º–∞–º–∏ (public –∏ tenant)

2. **Middleware** –º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å `request.state.company_id` –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

3. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** Query –ø–∞—Ä–∞–º–µ—Ç—Ä `company_id` –≤—Å–µ –µ—â–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `resolve_company_id()`

---

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2026-01-14

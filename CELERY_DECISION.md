# –†–µ—à–µ–Ω–∏–µ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é Celery –≤ –ø—Ä–æ–µ–∫—Ç–µ Barber SaaS

**–î–∞—Ç–∞:** 2026-01-14  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

---

## üìã –ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Celery –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á
### ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

---

## üéØ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

### 1. Celery –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:
- ‚úÖ **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–∞—Ö:**
  - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 7 –¥–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
  - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 3 –¥–Ω—è –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
  - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞ 1 –¥–µ–Ω—å –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
  - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏
  - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –Ω–µ–æ–ø–ª–∞—Ç–µ (–∫–∞–∂–¥—ã–µ 3 –¥–Ω—è –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è)

- ‚úÖ **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –∑–∞–ø–∏—Å–µ–π:**
  - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º –∑–∞ 1 –¥–µ–Ω—å –¥–æ –∑–∞–ø–∏—Å–∏
  - –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞–º –∑–∞ 1 —á–∞—Å –¥–æ –∑–∞–ø–∏—Å–∏
  - –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–∏—Å—Ç-–Ω–∞—Ä—è–¥–æ–≤ –º–∞—Å—Ç–µ—Ä–∞–º (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 08:00)

**–ü–æ—á–µ–º—É Celery:**
- –≠—Ç–∏ –∑–∞–¥–∞—á–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –ú–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –≤ —Ñ–æ–Ω–µ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ API
- –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ —Ç—Ä–µ–±—É—é—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ (Celery Beat)

### 2. –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è:
- ‚úÖ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç—É –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø–∏—Å–∏** (`send_booking_status_notification`)
- ‚úÖ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –æ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏** (`notify_admins_about_new_booking`)

**–ü–æ—á–µ–º—É —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ:**
- –ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞
- –ù—É–∂–Ω–∞ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
- –ü—Ä–æ—â–µ –æ—Ç–ª–∞–¥–∫–∞ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ù–µ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (Redis, worker)

---

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### Celery –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–§–∞–π–ª—ã:**
- `web/backend/celeryconfig.py` - –æ—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Celery
- `web/backend/app/tasks/subscription_notifications.py` - –∑–∞–¥–∞—á–∏ –¥–ª—è –ø–æ–¥–ø–∏—Å–æ–∫
- `web/backend/app/tasks/notifications.py` - –∑–∞–¥–∞—á–∏ –¥–ª—è –∑–∞–ø–∏—Å–µ–π

**Docker —Å–µ—Ä–≤–∏—Å—ã:**
- `celery-worker` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–¥–∞—á
- `celery-beat` - –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á
- `redis` - –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π

**–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á:**
```python
celery_app.conf.beat_schedule = {
    "check-subscriptions-7-days": {
        "task": "app.tasks.subscription_notifications.send_reminder_7_days_before",
        "schedule": crontab(hour=0, minute=0),  # –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 00:00 UTC
    },
    # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞—á–∏
}
```

### –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

**–§–∞–π–ª—ã:**
- `web/backend/app/api/bookings.py`:
  - `send_booking_status_notification()` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
  - `notify_admins_about_new_booking()` - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞–º

**–í—ã–∑–æ–≤:**
- –í—ã–∑—ã–≤–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ `update_booking()` –∏ `create_booking()`
- –ë–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Celery
- –° –¥–µ—Ç–∞–ª—å–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `get_async_session_maker`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `get_async_session_maker()` –≤ `app/database.py`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∏–º–ø–æ—Ä—Ç—ã –≤ `subscription_notifications.py`

### 2. –£–ø—Ä–æ—â–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- ‚úÖ –£–±—Ä–∞–Ω—ã HTTP –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ `httpx`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ `Bot.send_message()`
- ‚úÖ –£–±—Ä–∞–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç `bot_manager`

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã async –∑–∞–¥–∞—á–∏ Celery
- ‚úÖ Celery –∑–∞–¥–∞—á–∏ –æ–±–µ—Ä–Ω—É—Ç—ã –≤ `asyncio.run()` –¥–ª—è –∑–∞–ø—É—Å–∫–∞ async –∫–æ–¥–∞
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∏–º–µ–Ω–∞ –∑–∞–¥–∞—á –≤ `beat_schedule`

### 4. –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –≤—Å–µ—Ö –∑–∞–¥–∞—á
- ‚úÖ –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –æ—à–∏–±–∫–∏ –∏ –ø—Ä–∏—á–∏–Ω—ã –Ω–µ—É–¥–∞—á

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞:
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker compose ps | grep celery

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ worker
docker compose logs celery-worker --tail 20

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ beat
docker compose logs celery-beat --tail 20

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
docker compose exec celery-worker celery -A celeryconfig.celery_app inspect registered
```

### –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∑–∞–¥–∞—á–∏:
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∑–∞–¥–∞—á—É –≤—Ä—É—á–Ω—É—é
docker compose exec celery-worker celery -A celeryconfig.celery_app call app.tasks.subscription_notifications.send_reminder_7_days_before
```

---

## üìä –°—Ç–∞—Ç—É—Å

- ‚úÖ Celery worker –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ Celery beat –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ó–∞–¥–∞—á–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ (–≤—Å–µ 5 –∑–∞–¥–∞—á)
- ‚úÖ –ò–º–µ–Ω–∞ –∑–∞–¥–∞—á –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã (`app.tasks.subscription_notifications.*`)
- ‚úÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ `beat_schedule`
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ Async –∫–æ–¥ –æ–±–µ—Ä–Ω—É—Ç –≤ `asyncio.run()` –¥–ª—è Celery

**–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:**
- `app.tasks.subscription_notifications.send_reminder_7_days_before`
- `app.tasks.subscription_notifications.send_reminder_3_days_before`
- `app.tasks.subscription_notifications.send_reminder_1_day_before`
- `app.tasks.subscription_notifications.send_reminder_expiration`
- `app.tasks.subscription_notifications.send_payment_reminder`

---

## üéØ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

- [x] Celery worker –∏ beat –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [x] –ó–∞–¥–∞—á–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ Celery
- [x] –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ `beat_schedule`
- [x] –ò–º–µ–Ω–∞ –∑–∞–¥–∞—á –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω—ã
- [x] Async –∫–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±–µ—Ä–Ω—É—Ç –¥–ª—è Celery
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤—Ä–µ–º—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –ø–æ–¥–ø–∏—Å–∫–∞—Ö (—Ç—Ä–µ–±—É–µ—Ç—Å—è —Ç–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è —Å –∏—Å—Ç–µ–∫–∞—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–æ–π)

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **–î–ª—è MVP:** –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞–¥–µ–∂–Ω–µ–µ –∏ –ø—Ä–æ—â–µ –≤ –æ—Ç–ª–∞–¥–∫–µ
2. **–î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:** Celery –Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –∑–∞–¥–∞—á (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø–æ–¥–ø–∏—Å–∫–∞—Ö)
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ü—Ä–∏ —Ä–æ—Å—Ç–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Celery

---

**–í–µ—Ä—Å–∏—è:** 1.0  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2026-01-14
